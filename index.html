<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>表格分析系统</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            color: #333;
            line-height: 1.6;
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1800px;
            margin: 0 auto;
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }
        
        header {
            background: linear-gradient(90deg, #2c3e50, #4a6491);
            color: white;
            padding: 25px 30px;
            text-align: center;
            position: relative;
        }
        
        header h1 {
            font-size: 2.4rem;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }
        
        header p {
            font-size: 1.1rem;
            opacity: 0.9;
            max-width: 800px;
            margin: 0 auto;
        }
        
        .refresh-btn {
            position: absolute;
            top: 25px;
            right: 30px;
            background: rgba(255, 255, 255, 0.15);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1rem;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
        }
        
        .refresh-btn:hover {
            background: rgba(255, 255, 255, 0.25);
            transform: translateY(-2px);
        }
        
        .main-content {
            display: flex;
            flex-direction: column;
            padding: 30px;
        }
        
        .upload-section {
            background-color: #f8f9fa;
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 30px;
            border: 2px dashed #4a6491;
            text-align: center;
        }
        
        .upload-area {
            padding: 40px 20px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .upload-area:hover {
            background-color: #eef2f7;
        }
        
        .upload-icon {
            font-size: 3.5rem;
            color: #4a6491;
            margin-bottom: 15px;
        }
        
        .upload-text {
            margin-bottom: 10px;
        }
        
        .upload-text h3 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 1.5rem;
        }
        
        .upload-text p {
            color: #666;
            margin-bottom: 20px;
        }
        
        .upload-btn {
            background-color: #4a6491;
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 6px;
            font-size: 1rem;
            cursor: pointer;
            transition: background-color 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 10px;
        }
        
        .upload-btn:hover {
            background-color: #2c3e50;
        }
        
        .file-input {
            display: none;
        }
        
        .file-name {
            margin-top: 15px;
            color: #4a6491;
            font-weight: 600;
        }
        
        .process-section {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .process-btn {
            flex: 1;
            min-width: 200px;
            padding: 18px 20px;
            border-radius: 8px;
            border: none;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            font-weight: 600;
        }
        
        .process-btn i {
            font-size: 1.3rem;
        }
        
        .analyze-btn {
            background-color: #3498db;
            color: white;
        }
        
        .analyze-btn:hover {
            background-color: #2980b9;
        }
        
        .toggle-btn {
            background-color: #9b59b6;
            color: white;
        }
        
        .toggle-btn:hover {
            background-color: #8e44ad;
        }
        
        .export-btn {
            background-color: #2ecc71;
            color: white;
        }
        
        .export-btn:hover {
            background-color: #27ae60;
        }
        
        .export-btn:disabled {
            background-color: #95a5a6;
            cursor: not-allowed;
        }
        
        .ticket-stats-section {
            display: none;
            margin-bottom: 30px;
        }
        
        .data-section {
            display: none;
            flex-direction: column;
            gap: 30px;
        }
        
        .section-title {
            font-size: 1.4rem;
            color: #2c3e50;
            padding-bottom: 10px;
            border-bottom: 2px solid #eaeaea;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .search-section {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid #e0e0e0;
        }
        
        /* 修改后的搜索框样式 */
        .search-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .search-group {
            display: flex;
            align-items: center;
            gap: 8px;
            background-color: white;
            padding: 8px 12px;
            border-radius: 4px;
            border: 1px solid #ddd;
        }
        
        .search-group label {
            font-weight: 600;
            color: #2c3e50;
            white-space: nowrap;
            font-size: 0.9rem;
            min-width: 60px;
        }
        
        .search-group input {
            flex: 1;
            border: none;
            outline: none;
            font-size: 0.9rem;
            background: transparent;
            min-width: 120px;
        }
        
        .search-group input::placeholder {
            color: #aaa;
        }
        
        .search-buttons {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .search-btn {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .search-btn:hover {
            background-color: #2980b9;
        }
        
        .modify-btn {
            background-color: #f39c12;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .modify-btn:hover {
            background-color: #e67e22;
        }
        
        .modify-btn:disabled {
            background-color: #95a5a6;
            cursor: not-allowed;
        }
        
        /* 新增：添加乘客按钮样式 */
        .add-passenger-btn {
            background-color: #9b59b6;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .add-passenger-btn:hover {
            background-color: #8e44ad;
        }
        
        .search-results-info {
            margin-top: 10px;
            color: #4a6491;
            font-weight: 600;
        }
        
        .table-container {
            overflow-x: auto;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.05);
            max-height: 1000px;
            overflow-y: auto;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 1350px;
        }
        
        th {
            background-color: #4a6491;
            color: white;
            text-align: left;
            padding: 15px 12px;
            font-weight: 600;
            position: sticky;
            top: 0;
            white-space: nowrap;
        }
        
        td {
            padding: 12px;
            border-bottom: 1px solid #eee;
            font-size: 0.9rem;
        }
        
        tr:hover {
            background-color: #f9f9f9;
        }
        
        .select-checkbox {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }
        
        .select-all-cell {
            text-align: center;
        }
        
        .line-stats-panel {
            background-color: #f0f7ff;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .line-stats-title {
            font-size: 1.2rem;
            color: #2c3e50;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        /* 新增：线路统计面板显示/隐藏按钮样式 */
        .toggle-line-stats-btn {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
            margin-left: auto;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: all 0.3s;
        }
        
        .toggle-line-stats-btn:hover {
            background-color: #2980b9;
            transform: translateY(-2px);
        }
        
        .line-stats-content {
            display: block;
        }
        
        .line-stats-content.hidden {
            display: none;
        }
        
        .line-stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
        }
        
        .line-stat-item {
            background-color: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }
        
        .line-name {
            font-weight: 600;
            color: #4a6491;
            margin-bottom: 5px;
        }
        
        .line-count {
            font-size: 1.5rem;
            font-weight: 700;
            color: #2c3e50;
        }
        
        .line-label {
            font-size: 0.95rem;
            color: #666;
            line-height: 1.4;
        }
        
        .total-tickets {
            background-color: #e6f3ff;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            margin-top: 15px;
        }
        
        .total-tickets-value {
            font-size: 2.5rem;
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 5px;
        }
        
        .total-tickets-label {
            font-size: 1.1rem;
            color: #4a6491;
            font-weight: 600;
        }
        
        footer {
            text-align: center;
            padding: 20px;
            color: #666;
            border-top: 1px solid #eee;
            background-color: #f8f9fa;
        }
        
        @media (max-width: 768px) {
            .main-content {
                padding: 20px;
            }
            
            header h1 {
                font-size: 1.8rem;
            }
            
            .process-section {
                flex-direction: column;
            }
            
            .line-stats-grid {
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            }
            
            .refresh-btn {
                position: relative;
                top: 0;
                right: 0;
                margin-top: 15px;
                width: auto;
                display: inline-flex;
            }
            
            .search-container {
                grid-template-columns: 1fr;
            }
            
            .search-group input {
                min-width: 100px;
            }
            
            .search-buttons {
                justify-content: flex-start;
            }
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }
        
        .spinner {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #3498db;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            z-index: 1000;
            animation: slideIn 0.3s ease-out;
        }
        
        .notification.center {
            left: 50%;
            right: auto;
            transform: translateX(-50%);
            text-align: center;
        }
        
        .notification.success {
            background-color: #2ecc71;
        }
        
        .notification.error {
            background-color: #e74c3c;
        }
        
        .notification.info {
            background-color: #3498db;
        }
        
        .notification.warning {
            background-color: #f39c12;
        }
        
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        @keyframes slideOut {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }
        
        .required-field::after {
            content: " *";
            color: #e74c3c;
        }
        
        .compact-table th, .compact-table td {
            padding: 10px 8px;
        }
        
        .ticket-count {
            font-weight: 600;
            color: #2c3e50;
            text-align: center;
        }
        
        .data-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .data-header h3 {
            margin-bottom: 0;
        }
        
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 1001;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        .modal-content {
            background-color: white;
            border-radius: 12px;
            width: 90%;
            max-width: 1200px;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }
        
        .modal-header {
            background: linear-gradient(90deg, #4a6491, #2c3e50);
            color: white;
            padding: 20px;
            border-radius: 12px 12px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 1;
        }
        
        .modal-header h3 {
            font-size: 1.5rem;
            margin: 0;
        }
        
        .close-btn {
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
        }
        
        .modal-body {
            padding: 25px;
        }
        
        .modal-instructions {
            background-color: #f0f7ff;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            border-left: 4px solid #3498db;
        }
        
        .modal-instructions p {
            margin: 0;
            font-size: 0.95rem;
            color: #2c3e50;
        }
        
        .line-inputs-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            table-layout: fixed;
        }
        
        .line-inputs-table th {
            background-color: #f8f9fa;
            color: #2c3e50;
            font-weight: 600;
            padding: 12px 10px;
            border-bottom: 2px solid #e0e0e0;
            text-align: left;
        }
        
        .line-inputs-table td {
            padding: 10px;
            border-bottom: 1px solid #f0f0f0;
            overflow: hidden;
        }
        
        .line-inputs-table tr:hover {
            background-color: #f9f9f9;
        }
        
        .line-inputs-table th:nth-child(1) { width: 5%; }
        .line-inputs-table th:nth-child(2) { width: 15%; }
        .line-inputs-table th:nth-child(3) { width: 8%; }
        .line-inputs-table th:nth-child(4) { width: 10%; }
        .line-inputs-table th:nth-child(5) { width: 10%; }
        .line-inputs-table th:nth-child(6) { width: 10%; }
        .line-inputs-table th:nth-child(7) { width: 12%; }
        .line-inputs-table th:nth-child(8) { width: 12%; }
        .line-inputs-table th:nth-child(9) { width: 10%; }
        .line-inputs-table th:nth-child(10) { width: 8%; }
        
        .input-field {
            width: 100%;
            padding: 8px 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.9rem;
            transition: border-color 0.3s;
            box-sizing: border-box;
        }
        
        .input-field:focus {
            border-color: #3498db;
            outline: none;
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
        }
        
        .line-action-buttons {
            display: flex;
            gap: 5px;
            justify-content: center;
        }
        
        .add-line-btn, .remove-line-btn {
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s;
        }
        
        .remove-line-btn {
            background-color: #e74c3c;
        }
        
        .add-line-btn:hover {
            background-color: #2980b9;
            transform: scale(1.1);
        }
        
        .remove-line-btn:hover {
            background-color: #c0392b;
            transform: scale(1.1);
        }
        
        .remove-line-btn:disabled {
            background-color: #95a5a6;
            cursor: not-allowed;
        }
        
        .modal-footer {
            padding: 20px;
            border-top: 1px solid #e0e0e0;
            display: flex;
            justify-content: flex-end;
            gap: 15px;
        }
        
        .modal-btn {
            padding: 10px 25px;
            border-radius: 6px;
            border: none;
            font-size: 1rem;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .cancel-btn {
            background-color: #e0e0e0;
            color: #333;
        }
        
        .cancel-btn:hover {
            background-color: #d0d0d0;
        }
        
        .confirm-btn {
            background-color: #2ecc71;
            color: white;
        }
        
        .confirm-btn:hover {
            background-color: #27ae60;
        }
        
        .line-group {
            border-top: 3px solid #4a6491;
        }
        
        .plate-group {
            border-top: 2px dashed #4a6491;
        }
        
        .pickup-stats-row {
            background-color: #fffde7 !important;
            font-weight: 600;
            color: #2c3e50;
        }
        
        .pickup-stats-cell {
            padding: 8px 12px;
            font-size: 0.9rem;
        }
        
        .pickup-stats-cell .location-count {
            display: inline-block;
            background-color: #4a6491;
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.85rem;
            margin-right: 10px;
        }
        
        .ticket-stats-down {
            margin-top: 30px;
            transition: margin-top 0.3s ease;
        }
        
        .modify-modal-content {
            background-color: white;
            border-radius: 12px;
            width: 90%;
            max-width: 650px;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }
        
        .add-passenger-modal-content {
            background-color: white;
            border-radius: 12px;
            width: 90%;
            max-width: 650px;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }
        
        .modify-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .form-group label {
            font-weight: 600;
            color: #2c3e50;
        }
        
        .form-group .readonly-field {
            background-color: #f5f5f5;
            padding: 10px;
            border-radius: 4px;
            border: 1px solid #ddd;
            color: #666;
        }
        
        .form-group select {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 1rem;
        }
        
        .selected-row {
            background-color: #e6f3ff !important;
        }
        
        .highlight-row {
            background-color: #fffacd !important;
            animation: highlight 1.5s ease;
        }
        
        @keyframes highlight {
            0% { background-color: #fffacd; }
            100% { background-color: #fffacd; }
        }
        
        .show {
            display: block !important;
        }
        
        .vehicle-pickup-stats-panel {
            display: none;
            background-color: #f9f7ff;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            border: 2px solid #d1c4e9;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08);
        }
        
        .vehicle-pickup-stats-title {
            font-size: 1.2rem;
            color: #5e35b1;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .vehicle-pickup-stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 15px;
        }
        
        @media (max-width: 1400px) {
            .vehicle-pickup-stats-grid {
                grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            }
        }
        
        @media (max-width: 1100px) {
            .vehicle-pickup-stats-grid {
                grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            }
        }
        
        @media (max-width: 768px) {
            .vehicle-pickup-stats-grid {
                grid-template-columns: 1fr;
            }
        }
        
        .vehicle-stat-item {
            background-color: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            border-left: 4px solid #5e35b1;
            min-height: 180px;
            display: flex;
            flex-direction: column;
            width: 100%;
        }
        
        .vehicle-title {
            font-weight: 700;
            color: #5e35b1;
            margin-bottom: 8px;
            font-size: 1rem;
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 5px;
            min-height: 40px;
        }
        
        .vehicle-plate {
            font-weight: 700;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .vehicle-line {
            font-size: 0.9rem;
            color: #2c3e50;
            background-color: #e0e0e0;
            padding: 2px 8px;
            border-radius: 10px;
            white-space: nowrap;
        }
        
        .vehicle-pickup-stats {
            display: flex;
            flex-direction: column;
            gap: 6px;
            flex: 1;
            overflow-y: auto;
            max-height: 120px;
            padding-right: 5px;
        }
        
        .vehicle-pickup-stats::-webkit-scrollbar {
            width: 6px;
        }
        
        .vehicle-pickup-stats::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }
        
        .vehicle-pickup-stats::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 3px;
        }
        
        .vehicle-pickup-stats::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }
        
        .pickup-stat-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 5px 0;
            border-bottom: 1px dashed #f0f0f0;
            flex-shrink: 0;
        }
        
        .pickup-location {
            font-weight: 600;
            color: #333;
            flex: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-right: 8px;
        }
        
        .pickup-count {
            background-color: #5e35b1;
            color: white;
            padding: 2px 10px;
            border-radius: 12px;
            font-weight: 600;
            min-width: 50px;
            text-align: center;
            flex-shrink: 0;
        }
        
        .vehicle-total {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 8px;
            padding-top: 8px;
            border-top: 2px solid #e0e0e0;
            font-weight: 700;
            color: #2c3e50;
            flex-shrink: 0;
        }
        
        .vehicle-total-label {
            color: #5e35b1;
        }
        
        .vehicle-total-count {
            background-color: #2c3e50;
            color: white;
            padding: 3px 12px;
            border-radius: 12px;
        }
        
        .line-group-title {
            font-size: 1.1rem;
            color: #2c3e50;
            margin: 15px 0 10px 0;
            padding-bottom: 8px;
            border-bottom: 2px solid #5e35b1;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .line-group-title i {
            color: #5e35b1;
        }
        
        .unassigned-stat-item {
            background-color: #fff5f5;
            border-left: 4px solid #e74c3c;
        }
        
        .unassigned-title {
            color: #e74c3c;
        }
        
        .unassigned-count {
            background-color: #e74c3c;
            color: white;
        }
        
        .unassigned-label {
            color: #e74c3c;
        }
        
        .full-status {
            color: #2ecc71;
            font-weight: 700;
        }
        
        .available-status {
            color: #3498db;
            font-weight: 700;
        }
        
        .warning-status {
            color: #f39c12;
            font-weight: 700;
        }
        
        .seat-status {
            font-size: 0.85rem;
            padding: 2px 6px;
            border-radius: 4px;
            margin-left: 5px;
            font-weight: 600;
        }
        
        .seat-status-full {
            background-color: #2ecc71;
            color: white;
        }
        
        .seat-status-available {
            background-color: #3498db;
            color: white;
        }
        
        .seat-status-unlimited {
            background-color: #f39c12;
            color: white;
        }
        
        .seat-status-unassigned {
            background-color: #e74c3c;
            color: white;
        }
        
        .line-select-checkbox {
            width: 18px;
            height: 18px;
            cursor: pointer;
            margin-right: 5px;
        }
        
        .select-all-line-btn {
            background-color: #9b59b6;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
            margin-left: 10px;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }
        
        .select-all-line-btn:hover {
            background-color: #8e44ad;
        }
        
        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 5px;
        }
        
        .plate-checkbox {
            width: 18px;
            height: 18px;
            cursor: pointer;
            margin-right: 8px;
            vertical-align: middle;
        }
        
        .plate-header {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .unassigned-plate-group {
            border-top: 2px dashed #e74c3c;
        }
        
        .unassigned-plate-header {
            background-color: #fff5f5 !important;
        }
        
        .unassigned-line-checkbox {
            width: 16px;
            height: 16px;
            cursor: pointer;
            margin-right: 8px;
            vertical-align: middle;
        }
        
        .unassigned-line-label {
            font-weight: bold;
            cursor: pointer;
            color: #e74c3c;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .select-all-plate-btn {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 4px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85rem;
            margin-left: 8px;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }
        
        .select-all-plate-btn:hover {
            background-color: #2980b9;
        }
        
        .select-all-unassigned-btn {
            background-color: #e74c3c;
            color: white;
            border: none;
            padding: 4px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85rem;
            margin-left: 8px;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }
        
        .select-all-unassigned-btn:hover {
            background-color: #c0392b;
        }
        
        .manually-assigned-box {
            border: 2px solid #e74c3c !important;
            box-shadow: 0 0 5px rgba(231, 76, 60, 0.5);
        }
        
        .manually-assigned-label {
            color: #e74c3c !important;
            font-weight: bold;
        }
        
        .manual-assignment-text {
            color: #e74c3c;
            font-weight: bold;
            margin-top: 5px;
            padding: 3px 8px;
            background-color: #fff5f5;
            border-radius: 4px;
            display: inline-block;
        }
        
        .time-input {
            width: 100%;
            padding: 8px 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.9rem;
        }
        
        .plate-with-line {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 5px;
        }
        
        .line-in-plate {
            font-weight: 600;
            color: #2c3e50;
            background-color: #f0f0f0;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.9rem;
        }
        
        .stats-search-container {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            align-items: center;
        }
        
        .stats-search-input {
            flex: 1;
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 1rem;
            min-width: 200px;
        }
        
        .stats-search-dropdown {
            position: relative;
            min-width: 120px;
        }
        
        .stats-search-dropdown-btn {
            background-color: #5e35b1;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
            font-weight: 600;
            width: 100%;
        }
        
        .stats-search-dropdown-content {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            background-color: white;
            min-width: 150px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            border-radius: 4px;
            z-index: 100;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .stats-search-dropdown-item {
            padding: 10px 15px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .stats-search-dropdown-item:hover {
            background-color: #f0f0f0;
        }
        
        /* 修改后的弹窗搜索框样式 */
        .modal-search-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .modal-search-group {
            display: flex;
            align-items: center;
            gap: 8px;
            background-color: white;
            padding: 8px 12px;
            border-radius: 4px;
            border: 1px solid #ddd;
        }
        
        .modal-search-group label {
            font-weight: 600;
            color: #2c3e50;
            white-space: nowrap;
            font-size: 0.9rem;
            min-width: 60px;
        }
        
        .modal-search-group input {
            flex: 1;
            border: none;
            outline: none;
            font-size: 0.9rem;
            background: transparent;
            min-width: 120px;
        }
        
        .modal-search-group input::placeholder {
            color: #aaa;
        }
        
        .location-scroll {
            overflow-x: auto;
            white-space: nowrap;
            padding-bottom: 5px;
        }
        
        .location-scroll .pickup-stat-item {
            display: inline-flex;
            margin-right: 10px;
            border-bottom: none;
            border-right: 1px dashed #f0f0f0;
            padding-right: 10px;
        }
        
        .location-scroll .pickup-stat-item:last-child {
            border-right: none;
            margin-right: 0;
            padding-right: 0;
        }
        
        .location-scroll::-webkit-scrollbar {
            height: 6px;
        }
        
        .location-scroll::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }
        
        .location-scroll::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 3px;
        }
        
        .location-scroll::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }
        
        .filtered-out {
            display: none !important;
        }
        
        .no-results {
            text-align: center;
            padding: 20px;
            color: #666;
            font-style: italic;
        }
        
        .search-dropdown-multiselect {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-top: 5px;
        }
        
        .search-dropdown-multiselect-tag {
            background-color: #3498db;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .search-dropdown-multiselect-tag-remove {
            cursor: pointer;
            font-weight: bold;
        }
        
        .clear-search-btn {
            background-color: #95a5a6;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
            margin-left: 8px;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }
        
        .clear-search-btn:hover {
            background-color: #7f8c8d;
        }
        
        /* 新增的确认对话框样式 */
        .confirm-dialog-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 1002;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        .confirm-dialog {
            background-color: white;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            overflow: hidden;
        }
        
        .confirm-dialog-header {
            background: linear-gradient(90deg, #4a6491, #2c3e50);
            color: white;
            padding: 20px;
            border-radius: 12px 12px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .confirm-dialog-header h3 {
            font-size: 1.5rem;
            margin: 0;
        }
        
        .confirm-dialog-body {
            padding: 25px;
            font-size: 1.1rem;
            color: #2c3e50;
        }
        
        .confirm-dialog-footer {
            padding: 20px;
            border-top: 1px solid #e0e0e0;
            display: flex;
            justify-content: flex-end;
            gap: 15px;
        }
        
        .confirm-dialog-btn {
            padding: 10px 25px;
            border-radius: 6px;
            border: none;
            font-size: 1rem;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .confirm-dialog-cancel-btn {
            background-color: #e0e0e0;
            color: #333;
        }
        
        .confirm-dialog-cancel-btn:hover {
            background-color: #d0d0d0;
        }
        
        .confirm-dialog-ok-btn {
            background-color: #e74c3c;
            color: white;
        }
        
        .confirm-dialog-ok-btn:hover {
            background-color: #c0392b;
        }
        
        .vehicle-error-dialog {
            max-width: 600px;
        }
        
        .vehicle-error-list {
            max-height: 300px;
            overflow-y: auto;
            margin-top: 15px;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            padding: 10px;
        }
        
        .vehicle-error-item {
            padding: 8px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .vehicle-error-item:last-child {
            border-bottom: none;
        }
        
        .vehicle-error-plate {
            font-weight: bold;
            color: #e74c3c;
        }
        
        .vehicle-error-details {
            font-size: 0.9rem;
            color: #666;
        }
        
        /* 新增的刷新按钮样式 */
        .stats-refresh-btn {
            background-color: #f39c12;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            margin-left: auto;
            transition: all 0.3s;
        }
        
        .stats-refresh-btn:hover {
            background-color: #e67e22;
            transform: translateY(-2px);
        }
        
        .stats-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        /* 新增：底部拖拽区域样式 */
            .bottom-resize-area {
                position: absolute;
                bottom: 0;
                left: 0;
                width: 100%;
                height: 8px;
                cursor: ns-resize;
                z-index: 10;
                transition: background-color 0.2s;
            }

            .bottom-resize-area:hover {
                background-color: rgba(52, 152, 219, 0.2);
            }

            .bottom-resize-area:active {
                background-color: rgba(52, 152, 219, 0.4);
            }

        /* 新增：线路时间地点统计面板样式 */
        .line-time-location-panel {
            display: none;
            background-color: #f8fff0;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
            border: 2px solid #a8d18d;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.05);
            height: 400px; /* 设置初始高度 */
            overflow: hidden;
            flex-direction: column;
            position: relative; /* 为拖拽调整大小功能添加 */
        }
        
        .line-time-location-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            position: sticky;
            top: 0;
            background-color: #f8fff0;
            padding: 10px 0;
            z-index: 1;
        }
        
        .line-time-location-title {
            font-size: 1.2rem;
            color: #2c3e50;
            margin-bottom: 0;
            display: flex;
            align-items: center;
            gap: 10px;
            flex: 1;
        }
        
        .line-time-location-controls {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        /* 新增：拖拽调整大小手柄样式 */
        .resize-handle {
            background-color: #27ae60;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: ns-resize;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: all 0.3s;
        }
        
        .resize-handle:hover {
            background-color: #219955;
        }
        
        .resize-handle:active {
            cursor: ns-resize;
        }
        
        .line-time-location-search {
            margin-bottom: 15px;
            flex-shrink: 0;
        }
        
        .line-time-location-search-input {
            width: 100%;
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 1rem;
            margin-bottom: 10px;
        }
        
        .line-time-location-search-input:focus {
            border-color: #3498db;
            outline: none;
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
        }
        
        .line-time-location-table-container {
            overflow-y: auto;
            flex: 1;
            min-height: 100px;
        }
        
        .line-time-location-table {
            width: 100%;
            border-collapse: collapse;
            table-layout: fixed;
        }
        
        .line-time-location-table th {
            background-color: #27ae60;
            color: white;
            text-align: left;
            padding: 12px 8px;
            font-weight: 600;
            position: sticky;
            top: 0;
            white-space: nowrap;
        }
        
        .line-time-location-table td {
            padding: 10px 8px;
            border-bottom: 1px solid #eee;
            font-size: 0.9rem;
            word-break: break-word;
            overflow-wrap: break-word;
        }
        
        .line-time-location-table tr:hover {
            background-color: #f9f9f9;
        }
        
        .time-location-stat-item {
            background-color: white;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 4px solid #27ae60;
        }
        
        .time-location-line {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 5px;
        }
        
        .time-location-details {
            font-size: 0.95rem;
            color: #666;
            line-height: 1.4;
        }
        
        .time-location-count {
            font-weight: 700;
            color: #27ae60;
            font-size: 1.1rem;
        }
        
        /* 新增：删除乘客按钮样式 - 修改为与"确认修改"按钮大小相同 */
        .delete-passenger-btn {
            background-color: #e74c3c;
            color: white;
            border: none;
            padding: 10px 25px;
            border-radius: 6px;
            font-size: 1rem;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .delete-passenger-btn:hover {
            background-color: #c0392b;
        }
        
        /* 新增：导出排序选择对话框样式 */
        .export-sort-dialog {
            max-width: 400px;
        }
        
        .export-sort-options {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-top: 15px;
        }
        
        .export-sort-option {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            border-radius: 6px;
            border: 1px solid #ddd;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .export-sort-option:hover {
            background-color: #f5f5f5;
        }
        
        .export-sort-option.selected {
            background-color: #e6f3ff;
            border-color: #3498db;
        }
        
        .export-sort-option input[type="radio"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        
        .export-sort-option label {
            font-weight: 600;
            color: #2c3e50;
            cursor: pointer;
            flex: 1;
        }
        
        .export-sort-option-desc {
            font-size: 0.9rem;
            color: #666;
            margin-top: 3px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1><i class="fas fa-route"></i> 表格分析系统</h1>
            <button class="refresh-btn" id="refreshBtn">
                <i class="fas fa-redo"></i> 刷新
            </button>
            <p>上传Excel文件，分析并整合线路订单数据</p>
        </header>
        
        <div class="main-content">
            <div class="upload-section">
                <div class="upload-area" id="uploadArea">
                    <div class="upload-icon">
                        <i class="fas fa-file-excel"></i>
                    </div>
                    <div class="upload-text">
                        <h3>请上传Excel文件</h3>
                        <p>支持 .xlsx, .xls 格式</p>
                        <button class="upload-btn" id="uploadBtn">
                            <i class="fas fa-cloud-upload-alt"></i> 选择Excel文件
                        </button>
                        <input type="file" id="fileInput" class="file-input" accept=".xlsx,.xls">
                        <div id="fileName" class="file-name"></div>
                    </div>
                </div>
            </div>
            
            <div class="process-section">
                <button class="process-btn analyze-btn" id="analyzeBtn">
                    <i class="fas fa-chart-bar"></i> 分析并整合数据
                </button>
                <button class="process-btn toggle-btn" id="toggleBtn" disabled>
                    <i class="fas fa-eye"></i> 显示整合后的数据
                </button>
                <button class="process-btn export-btn" id="exportBtn" disabled>
                    <i class="fas fa-file-export"></i> 导出Excel文件
                </button>
            </div>
            
            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p>正在处理数据，请稍候...</p>
            </div>
            
            <div class="ticket-stats-section" id="ticketStatsSection">
                <div class="line-stats-panel" id="lineStatsPanel">
                    <!-- 线路票数统计内容将在这里动态生成 -->
                </div>
                
                <!-- 新增：各线路时间地点人员统计面板 -->
                <div class="line-time-location-panel" id="lineTimeLocationPanel">
                    <div class="line-time-location-header">
                        <div class="line-time-location-title">
                            <i class="fas fa-clock"></i> 各线路时间地点人员统计
                        </div>
                        <div class="line-time-location-controls">
                            <button class="resize-handle" id="resizeHandle" title="拖拽调整高度">
                                <i class="fas fa-arrows-alt-v"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div class="line-time-location-search">
                        <input type="text" class="line-time-location-search-input" id="lineTimeLocationSearch" 
                               placeholder="输入线路名称进行筛选...">
                    </div>
                    
                    <div class="line-time-location-table-container" id="lineTimeLocationTableContainer">
                        <table class="line-time-location-table" id="lineTimeLocationTable">
                            <thead>
                                <tr>
                                    <th>线路</th>
                                    <th>乘车时间</th>
                                    <th>上车地点</th>
                                    <th>下车地点</th>
                                    <th>人数</th>
                                </tr>
                            </thead>
                            <tbody id="lineTimeLocationBody">
                                <!-- 时间地点统计数据将在这里动态生成 -->
                            </tbody>
                        </table>
                    </div>

                    <div class="bottom-resize-area" id="bottomResizeArea" title="拖拽调整高度"></div>

                </div>
            </div>
            
            <div class="vehicle-pickup-stats-panel" id="vehiclePickupStatsPanel">
            </div>
            
            <div class="data-section" id="dataSection">
                <div class="data-header">
                    <h3 class="section-title"><i class="fas fa-chart-pie"></i> 整合后的线路订单数据</h3>
                </div>
                
                <div class="search-section">
                    <!-- 修改后的搜索框：6个检索项 -->
                    <div class="search-container">
                        <div class="search-group">
                            <label>联系人:</label>
                            <input type="text" id="searchContact" placeholder="请输入联系人...">
                        </div>
                        <div class="search-group">
                            <label>联系电话:</label>
                            <input type="text" id="searchPhone" placeholder="请输入联系电话...">
                        </div>
                        <div class="search-group">
                            <label>车牌号码:</label>
                            <input type="text" id="searchPlate" placeholder="请输入车牌号码...">
                        </div>
                        <div class="search-group">
                            <label>线路:</label>
                            <input type="text" id="searchLine" placeholder="请输入线路...">
                        </div>
                        <div class="search-group">
                            <label>上车地点:</label>
                            <input type="text" id="searchPickup" placeholder="请输入上车地点...">
                        </div>
                        <div class="search-group">
                            <label>下车地点:</label>
                            <input type="text" id="searchDropoff" placeholder="请输入下车地点...">
                        </div>
                        <!-- 新增：添加乘客按钮 -->
                        <div class="search-group" style="justify-content: center; border: none; background-color: transparent;">
                            <button class="add-passenger-btn" id="addPassengerBtn">
                                <i class="fas fa-user-plus"></i> 添加乘客
                            </button>
                        </div>
                    </div>
                    
                    <div class="search-buttons">
                        <button class="search-btn" id="searchBtn">
                            <i class="fas fa-search"></i> 搜索
                        </button>
                        <button class="search-btn" id="refreshSearchBtn">
                            <i class="fas fa-redo"></i> 刷新数据
                        </button>
                        <button class="clear-search-btn" id="clearSearchBtn">
                            <i class="fas fa-times"></i> 清除
                        </button>
                        <button class="modify-btn" id="modifyBtn" disabled>
                            <i class="fas fa-edit"></i> 修改选中项
                        </button>
                        <button class="select-all-plate-btn" id="selectAllPlateBtn" style="display:none;">
                            <i class="fas fa-check-square"></i> 全选此车牌
                        </button>
                        <button class="select-all-unassigned-btn" id="selectAllUnassignedBtn" style="display:none;">
                            <i class="fas fa-check-square"></i> 全选此线路未分配
                        </button>
                    </div>
                    
                    <div class="search-results-info" id="searchResultsInfo"></div>
                </div>
                
                <div class="table-container">
                    <table id="processedTable" class="compact-table">
                        <thead>
                            <tr>
                                <th class="select-all-cell">
                                    <input type="checkbox" id="selectAllCheckbox" class="select-checkbox">
                                </th>
                                <th class="required-field">订单ID</th>
                                <th class="required-field">线路</th>
                                <th>车牌号码</th>
                                <th class="required-field">联系人</th>
                                <th class="required-field">联系电话</th>
                                <th>票数</th>
                                <th class="required-field">乘车日期</th>
                                <th>乘车时间</th>
                                <th class="required-field">上车地点</th>
                                <th class="required-field">下车地点</th>
                                <th>随车负责人</th>
                                <th>随车负责人电话</th>
                                <th>通知内容</th>
                                <th>查看注意事项</th>
                            </tr>
                        </thead>
                        <tbody id="processedData">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <footer>
            <p></p>
        </footer>
    </div>

    <div class="modal-overlay" id="modalOverlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-edit"></i> 为各线路填写车辆信息</h3>
                <button class="close-btn" id="closeModalBtn">&times;</button>
            </div>
            <div class="modal-body">
                <div class="modal-instructions">
                    <p><i class="fas fa-info-circle"></i> 请为各线路填写车辆信息。注意！！！请将每条路线满员的车辆放在前面，拼车的车辆放在后面。<br>
                    <strong>人员分配说明：</strong>输入每辆车的人数限制，系统会按照输入的人数分配订单。若车辆填写了时间，上车地点或下车地点，则该车只会放对应地点和时间的人。<br>
                    <strong>重要提示：</strong>如果为不同线路分配了同一个车牌号，那么他们的人数必须相同。</p>
                </div>
                
                <!-- 修改后的弹窗搜索框：2个检索项 -->
                <div class="modal-search-container">
                    <div class="modal-search-group">
                        <label>线路:</label>
                        <input type="text" id="modalSearchLine" placeholder="请输入线路...">
                    </div>
                    <div class="modal-search-group">
                        <label>车牌号:</label>
                        <input type="text" id="modalSearchPlate" placeholder="请输入车牌号...">
                    </div>
                </div>
                
                <div class="table-container">
                    <table class="line-inputs-table">
                        <thead>
                            <tr>
                                <th>操作</th>
                                <th>线路</th>
                                <th>乘车时间</th>
                                <th>上车地点</th>
                                <th>下车地点</th>
                                <th>人数</th>
                                <th>车牌号码</th>
                                <th>随车负责人</th>
                                <th>随车负责人电话</th>
                                <th>通知内容</th>
                            </tr>
                        </thead>
                        <tbody id="lineInputsBody">
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button class="modal-btn cancel-btn" id="cancelBtn">取消</button>
                <button class="modal-btn confirm-btn" id="confirmBtn">确定并分析数据</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="modifyModalOverlay">
        <div class="modal-content modify-modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-edit"></i> 修改订单信息</h3>
                <button class="close-btn" id="closeModifyModalBtn">&times;</button>
            </div>
            <div class="modal-body">
                <div class="modal-instructions">
                    <p><i class="fas fa-info-circle"></i> 修改选中订单的信息。车牌号码、随车负责人、随车负责人电话、上车地点、乘车时间、下车地点和通知内容可修改，其他信息为只读。<br>
                    <strong>注意：</strong>如果填写已有车牌号，订单将归并到该车牌下，并更新车辆统计信息。</p>
                </div>
                <div class="modify-form" id="modifyForm">
                </div>
            </div>
            <div class="modal-footer">
                <button class="delete-passenger-btn" id="deletePassengerBtn" style="display: none;">
                    <i class="fas fa-trash-alt"></i> 删除此乘客
                </button>
                <button class="modal-btn cancel-btn" id="cancelModifyBtn">取消</button>
                <button class="modal-btn confirm-btn" id="confirmModifyBtn">确认修改</button>
            </div>
        </div>
    </div>

    <!-- 新增：添加乘客弹窗 -->
    <div class="modal-overlay" id="addPassengerModalOverlay">
        <div class="modal-content add-passenger-modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-user-plus"></i> 添加乘客</h3>
                <button class="close-btn" id="closeAddPassengerModalBtn">&times;</button>
            </div>
            <div class="modal-body">
                <div class="modal-instructions">
                    <p><i class="fas fa-info-circle"></i> 添加新的乘客订单。</p>
                </div>
                <div class="modify-form" id="addPassengerForm">
                    <div class="form-group">
                        <label>订单ID</label>
                        <input type="text" id="addPassengerOrderId" class="input-field" placeholder="请输入订单ID">
                    </div>
                    <div class="form-group">
                        <label>线路名称</label>
                        <input type="text" id="addPassengerLine" class="input-field" placeholder="请输入线路名称">
                    </div>
                    <div class="form-group">
                        <label>联系人</label>
                        <input type="text" id="addPassengerContact" class="input-field" placeholder="请输入联系人">
                    </div>
                    <div class="form-group">
                        <label>联系电话</label>
                        <input type="text" id="addPassengerPhone" class="input-field" placeholder="请输入联系电话">
                    </div>
                    <div class="form-group">
                        <label>票数</label>
                        <input type="number" id="addPassengerTicketCount" class="input-field" placeholder="请输入票数" min="1" value="1">
                    </div>
                    <div class="form-group">
                        <label>上车地点</label>
                        <input type="text" id="addPassengerPickup" class="input-field" placeholder="请输入上车地点">
                    </div>
                    <div class="form-group">
                        <label>下车地点</label>
                        <input type="text" id="addPassengerDropoff" class="input-field" placeholder="请输入下车地点">
                    </div>
                    <div class="form-group">
                        <label>乘车日期</label>
                        <input type="text" id="addPassengerDate" class="input-field" placeholder="请输入乘车日期">
                    </div>
                    <div class="form-group">
                        <label>乘车时间</label>
                        <input type="text" id="addPassengerTime" class="input-field" placeholder="请输入乘车时间">
                    </div>
                    <div class="form-group">
                        <label>车牌号码</label>
                        <input type="text" id="addPassengerPlate" class="input-field" placeholder="请输入车牌号码">
                        <small style="color:#666;">为空则表示为未分配车辆</small>
                    </div>
                    <div class="form-group">
                        <label>随车负责人</label>
                        <input type="text" id="addPassengerManager" class="input-field" placeholder="请输入随车负责人">
                        <small style="color:#666;">为空则自动匹配输入车牌号中的信息</small>
                    </div>
                    <div class="form-group">
                        <label>随车负责人电话</label>
                        <input type="text" id="addPassengerManagerPhone" class="input-field" placeholder="请输入随车负责人电话">
                        <small style="color:#666;">为空则自动匹配输入车牌号中的信息</small>
                    </div>
                    <div class="form-group">
                        <label>通知内容</label>
                        <textarea id="addPassengerNotice" class="input-field" rows="3" placeholder="请输入通知内容"></textarea>
                        <small style="color:#666;">为空则自动匹配输入车牌号中的信息</small>
                    </div>
                    <div class="form-group">
                        <label>查看注意事项</label>
                        <textarea id="addPassengerNotes" class="input-field" rows="3" placeholder="请输入查看注意事项"></textarea>
                        <small style="color:#666;">为空则自动匹配输入车牌号中的信息</small>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="modal-btn cancel-btn" id="cancelAddPassengerBtn">取消</button>
                <button class="modal-btn confirm-btn" id="confirmAddPassengerBtn">确认添加</button>
            </div>
        </div>
    </div>

    <!-- 新增的确认对话框 -->
    <div class="confirm-dialog-overlay" id="confirmDialogOverlay">
        <div class="confirm-dialog">
            <div class="confirm-dialog-header">
                <h3><i class="fas fa-exclamation-triangle"></i> 确认刷新</h3>
            </div>
            <div class="confirm-dialog-body">
                刷新会清空所有数据，是否刷新？
            </div>
            <div class="confirm-dialog-footer">
                <button class="confirm-dialog-btn confirm-dialog-cancel-btn" id="confirmDialogCancelBtn">取消</button>
                <button class="confirm-dialog-btn confirm-dialog-ok-btn" id="confirmDialogOkBtn">确定</button>
            </div>
        </div>
    </div>

    <!-- 新增：删除乘客确认对话框 -->
    <div class="confirm-dialog-overlay" id="deleteConfirmDialogOverlay">
        <div class="confirm-dialog">
            <div class="confirm-dialog-header">
                <h3><i class="fas fa-exclamation-triangle"></i> 确认删除</h3>
            </div>
            <div class="confirm-dialog-body" id="deleteConfirmDialogBody">
                确定要删除这个乘客订单吗？此操作无法撤销。
            </div>
            <div class="confirm-dialog-footer">
                <button class="confirm-dialog-btn confirm-dialog-cancel-btn" id="deleteConfirmDialogCancelBtn">取消</button>
                <button class="confirm-dialog-btn confirm-dialog-ok-btn" id="deleteConfirmDialogOkBtn">确定删除</button>
            </div>
        </div>
    </div>

    <!-- 新增的车牌错误对话框 -->
    <div class="confirm-dialog-overlay" id="vehicleErrorDialogOverlay">
        <div class="confirm-dialog vehicle-error-dialog">
            <div class="confirm-dialog-header">
                <h3><i class="fas fa-exclamation-triangle"></i> 车辆信息错误</h3>
            </div>
            <div class="confirm-dialog-body">
                <p>以下车牌在不同线路中的人数设置不一致，请修改：</p>
                <div class="vehicle-error-list" id="vehicleErrorList">
                    <!-- 错误列表将在这里动态生成 -->
                </div>
                <p style="margin-top: 15px; color: #e74c3c; font-weight: bold;">
                    注意：同一个车牌在不同线路中必须是同一辆车，人数必须相同。
                </p>
            </div>
            <div class="confirm-dialog-footer">
                <button class="confirm-dialog-btn confirm-dialog-ok-btn" id="vehicleErrorDialogOkBtn">我知道了</button>
            </div>
        </div>
    </div>

    <!-- 新增：导出排序选择对话框 -->
    <div class="confirm-dialog-overlay" id="exportSortDialogOverlay">
        <div class="confirm-dialog export-sort-dialog">
            <div class="confirm-dialog-header">
                <h3><i class="fas fa-sort"></i> 选择导出排序方式</h3>
            </div>
            <div class="confirm-dialog-body">
                <p>请选择每个车组内的排序方式：</p>
                <div class="export-sort-options">
                    <div class="export-sort-option" id="sortByLineOption">
                        <input type="radio" id="sortByLine" name="exportSort" value="line">
                        <div>
                            <label for="sortByLine">按线路排序（适用返校）</label>
                            <div class="export-sort-option-desc">在每个车组内，按线路排序</div>
                        </div>
                    </div>
                    <div class="export-sort-option" id="sortByCampusOption">
                        <input type="radio" id="sortByCampus" name="exportSort" value="campus">
                        <div>
                            <label for="sortByCampus">按校区排序（适用返乡）</label>
                            <div class="export-sort-option-desc">在每个车组内，按校区排序</div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="confirm-dialog-footer">
                <button class="confirm-dialog-btn confirm-dialog-cancel-btn" id="exportSortDialogCancelBtn">取消</button>
                <button class="confirm-dialog-btn confirm-dialog-ok-btn" id="exportSortDialogOkBtn">确定导出</button>
            </div>
        </div>
    </div>

    <script>
        // 全局变量
        let originalData = [];
        let processedData = [];
        let filteredData = [];
        let workbook = null;
        let fileName = "";
        let colorMap = new Map();
        let lineColorMap = new Map();
        let colorIndex = 0;
        let isDataVisible = false;
        let lineInfo = {};
        let selectedRows = new Set();
        let isSearchActive = false;
        let vehiclePickupStats = {};
        let lineOrder = [];
        let lineUnassignedCount = {};
        let vehicleCapacityMap = new Map();
        let lastLineInfo = {};
        let plateStats = {};
        let manuallyAssignedOrders = new Set();
        let lineManuallyAssignedCount = {};
        let plateLineMap = new Map();
        
        // 新增：线路统计面板显示状态
        let lineStatsVisible = true;
        
        // 新增：调整大小功能变量
        let isResizing = false;
        let startY, startHeight;
        
        // 新增：车辆信息检查结果
        let vehicleInfoErrors = [];
        
        // 新增：车辆总人数共享跟踪
        let vehicleTotalAssigned = new Map(); // 车牌 -> 已分配总人数
        
        // 新增：线路时间地点统计数据
        let lineTimeLocationData = [];
        
        // 新增：导出排序方式
        let exportSortType = 'line'; // 默认按线路排序
        
        // 预定义的颜色集合
        const colorPalette = [
            "#E6F3FF", "#E6FFE6", "#FFF0E6", "#FFF6E6", "#F0E6FF",
            "#FFE6F2", "#E6FFFF", "#FFF0F5", "#F5F5DC", "#F0FFF0",
            "#FFE6E6", "#E6E6FF", "#FFFFE6", "#E6F5FF", "#F0F8FF",
            "#FAFAD2", "#F5F5F5", "#FFFACD", "#E0FFFF", "#F0FFF0",
            "#F5F5DC", "#FFF8DC", "#FFFAF0", "#F8F8FF", "#F5F5F5",
            "#FFF5EE", "#F5FFFA", "#FFFAFA", "#F0F8FF", "#F8F8FF"
        ];
        
        // DOM元素
        const fileInput = document.getElementById('fileInput');
        const uploadBtn = document.getElementById('uploadBtn');
        const uploadArea = document.getElementById('uploadArea');
        const fileNameDisplay = document.getElementById('fileName');
        const analyzeBtn = document.getElementById('analyzeBtn');
        const toggleBtn = document.getElementById('toggleBtn');
        const exportBtn = document.getElementById('exportBtn');
        const processedDataBody = document.getElementById('processedData');
        const ticketStatsSection = document.getElementById('ticketStatsSection');
        const lineStatsPanel = document.getElementById('lineStatsPanel');
        const loading = document.getElementById('loading');
        const dataSection = document.getElementById('dataSection');
        const refreshBtn = document.getElementById('refreshBtn');
        const vehiclePickupStatsPanel = document.getElementById('vehiclePickupStatsPanel');
        const selectAllPlateBtn = document.getElementById('selectAllPlateBtn');
        const selectAllUnassignedBtn = document.getElementById('selectAllUnassignedBtn');
        
        // 新增：线路时间地点统计相关元素
        const lineTimeLocationPanel = document.getElementById('lineTimeLocationPanel');
        const lineTimeLocationBody = document.getElementById('lineTimeLocationBody');
        const lineTimeLocationSearch = document.getElementById('lineTimeLocationSearch');
        const lineTimeLocationTableContainer = document.getElementById('lineTimeLocationTableContainer');
        const resizeHandle = document.getElementById('resizeHandle');
        
        // 搜索相关元素
        const searchBtn = document.getElementById('searchBtn');
        const clearSearchBtn = document.getElementById('clearSearchBtn');
        const modifyBtn = document.getElementById('modifyBtn');
        const addPassengerBtn = document.getElementById('addPassengerBtn'); // 新增
        const searchResultsInfo = document.getElementById('searchResultsInfo');
        const selectAllCheckbox = document.getElementById('selectAllCheckbox');
        
        // 搜索输入框
        const searchContact = document.getElementById('searchContact');
        const searchPhone = document.getElementById('searchPhone');
        const searchPlate = document.getElementById('searchPlate');
        const searchLine = document.getElementById('searchLine');
        const searchPickup = document.getElementById('searchPickup');
        const searchDropoff = document.getElementById('searchDropoff');
        
                // 新增：搜索框刷新按钮元素
        const refreshSearchBtn = document.getElementById('refreshSearchBtn');

        // 在事件监听器部分添加
        refreshSearchBtn.addEventListener('click', refreshSearchData);

        // 新增：刷新搜索数据函数
        function refreshSearchData() {
            // 清空所有搜索输入框
            searchContact.value = '';
            searchPhone.value = '';
            searchPlate.value = '';
            searchLine.value = '';
            searchPickup.value = '';
            searchDropoff.value = '';
            
            // 重置搜索状态
            isSearchActive = false;
            filteredData = [];
            
            // 更新搜索结果信息
            searchResultsInfo.textContent = `显示全部 ${processedData.length} 条数据`;
            searchResultsInfo.style.color = '#4a6491';
            
            // 清空选中行
            selectedRows.clear();
            selectAllCheckbox.checked = false;
            updateModifyButtonState();
            selectAllPlateBtn.style.display = 'none';
            selectAllUnassignedBtn.style.display = 'none';
            
            // 重新显示数据
            if (isDataVisible) {
                displayProcessedData();
                displayVehiclePickupStatsPanel();
            }
            
            showNotification('搜索数据已刷新，显示全部数据', 'success');
        }


        // 线路信息填写弹窗相关元素
        const modalOverlay = document.getElementById('modalOverlay');
        const closeModalBtn = document.getElementById('closeModalBtn');
        const cancelBtn = document.getElementById('cancelBtn');
        const confirmBtn = document.getElementById('confirmBtn');
        const lineInputsBody = document.getElementById('lineInputsBody');
        
        // 弹窗搜索输入框
        const modalSearchLine = document.getElementById('modalSearchLine');
        const modalSearchPlate = document.getElementById('modalSearchPlate');
        
        // 修改数据弹窗相关元素
        const modifyModalOverlay = document.getElementById('modifyModalOverlay');
        const closeModifyModalBtn = document.getElementById('closeModifyModalBtn');
        const cancelModifyBtn = document.getElementById('cancelModifyBtn');
        const confirmModifyBtn = document.getElementById('confirmModifyBtn');
        const modifyForm = document.getElementById('modifyForm');
        const deletePassengerBtn = document.getElementById('deletePassengerBtn'); // 新增
        
        // 新增：添加乘客弹窗相关元素
        const addPassengerModalOverlay = document.getElementById('addPassengerModalOverlay');
        const closeAddPassengerModalBtn = document.getElementById('closeAddPassengerModalBtn');
        const cancelAddPassengerBtn = document.getElementById('cancelAddPassengerBtn');
        const confirmAddPassengerBtn = document.getElementById('confirmAddPassengerBtn');
        const addPassengerForm = document.getElementById('addPassengerForm');
        
        // 新增：导出排序对话框元素
        const exportSortDialogOverlay = document.getElementById('exportSortDialogOverlay');
        const exportSortDialogCancelBtn = document.getElementById('exportSortDialogCancelBtn');
        const exportSortDialogOkBtn = document.getElementById('exportSortDialogOkBtn');
        const sortByLineOption = document.getElementById('sortByLineOption');
        const sortByCampusOption = document.getElementById('sortByCampusOption');
        
        // 新增：删除确认对话框元素
        const deleteConfirmDialogOverlay = document.getElementById('deleteConfirmDialogOverlay');
        const deleteConfirmDialogCancelBtn = document.getElementById('deleteConfirmDialogCancelBtn');
        const deleteConfirmDialogOkBtn = document.getElementById('deleteConfirmDialogOkBtn');
        const deleteConfirmDialogBody = document.getElementById('deleteConfirmDialogBody');
        
        // 新增：确认对话框元素
        const confirmDialogOverlay = document.getElementById('confirmDialogOverlay');
        const confirmDialogCancelBtn = document.getElementById('confirmDialogCancelBtn');
        const confirmDialogOkBtn = document.getElementById('confirmDialogOkBtn');
        
        // 新增：车牌错误对话框元素
        const vehicleErrorDialogOverlay = document.getElementById('vehicleErrorDialogOverlay');
        const vehicleErrorList = document.getElementById('vehicleErrorList');
        const vehicleErrorDialogOkBtn = document.getElementById('vehicleErrorDialogOkBtn');
        
        // 事件监听器
        uploadBtn.addEventListener('click', () => fileInput.click());
        uploadArea.addEventListener('click', () => fileInput.click());
        refreshBtn.addEventListener('click', showRefreshConfirm);
        
        fileInput.addEventListener('change', handleFileUpload);
        analyzeBtn.addEventListener('click', showLineInfoModal);
        toggleBtn.addEventListener('click', toggleDataView);
        exportBtn.addEventListener('click', showExportSortDialog); // 修改：改为显示排序选择对话框
        
        // 搜索相关事件
        searchBtn.addEventListener('click', performSearch);
        clearSearchBtn.addEventListener('click', clearSearch);
        modifyBtn.addEventListener('click', showModifyModal);
        addPassengerBtn.addEventListener('click', showAddPassengerModal); // 新增
        selectAllCheckbox.addEventListener('change', toggleSelectAll);
        selectAllPlateBtn.addEventListener('click', selectAllCurrentPlate);
        selectAllUnassignedBtn.addEventListener('click', selectAllCurrentLineUnassigned);
        
        // 为搜索输入框添加回车键搜索
        searchContact.addEventListener('keyup', (e) => { if (e.key === 'Enter') performSearch(); });
        searchPhone.addEventListener('keyup', (e) => { if (e.key === 'Enter') performSearch(); });
        searchPlate.addEventListener('keyup', (e) => { if (e.key === 'Enter') performSearch(); });
        searchLine.addEventListener('keyup', (e) => { if (e.key === 'Enter') performSearch(); });
        searchPickup.addEventListener('keyup', (e) => { if (e.key === 'Enter') performSearch(); });
        searchDropoff.addEventListener('keyup', (e) => { if (e.key === 'Enter') performSearch(); });
        
        // 新增：线路时间地点统计搜索事件
        lineTimeLocationSearch.addEventListener('input', filterLineTimeLocationData);
        
        // 新增：调整大小事件
        if (resizeHandle) {
            resizeHandle.addEventListener('mousedown', startResize);
        }
        
        // 弹窗搜索输入框事件
        modalSearchLine.addEventListener('input', filterModalRows);
        modalSearchPlate.addEventListener('input', filterModalRows);
        
        // 线路信息填写弹窗事件监听器
        closeModalBtn.addEventListener('click', closeModal);
        cancelBtn.addEventListener('click', closeModal);
        confirmBtn.addEventListener('click', processDataWithLineInfo);
        
        // 修改弹窗事件监听器
        closeModifyModalBtn.addEventListener('click', closeModifyModal);
        cancelModifyBtn.addEventListener('click', closeModifyModal);
        confirmModifyBtn.addEventListener('click', confirmModify);
        deletePassengerBtn.addEventListener('click', showDeleteConfirmDialog); // 新增
        
        // 新增：添加乘客弹窗事件监听器
        closeAddPassengerModalBtn.addEventListener('click', closeAddPassengerModal);
        cancelAddPassengerBtn.addEventListener('click', closeAddPassengerModal);
        confirmAddPassengerBtn.addEventListener('click', confirmAddPassenger);
        
        // 新增：导出排序对话框事件监听器
        exportSortDialogCancelBtn.addEventListener('click', closeExportSortDialog);
        exportSortDialogOkBtn.addEventListener('click', confirmExportSort);
        sortByLineOption.addEventListener('click', () => {
            document.getElementById('sortByLine').checked = true;
            exportSortType = 'line';
        });
        sortByCampusOption.addEventListener('click', () => {
            document.getElementById('sortByCampus').checked = true;
            exportSortType = 'campus';
        });
        
        // 新增：删除确认对话框事件监听器
        deleteConfirmDialogCancelBtn.addEventListener('click', closeDeleteConfirmDialog);
        deleteConfirmDialogOkBtn.addEventListener('click', confirmDeletePassenger);
        
        // 新增：确认对话框事件监听器
        confirmDialogCancelBtn.addEventListener('click', closeConfirmDialog);
        confirmDialogOkBtn.addEventListener('click', confirmRefresh);
        vehicleErrorDialogOkBtn.addEventListener('click', closeVehicleErrorDialog);
        
        // 处理文件上传
        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            fileName = file.name;
            fileNameDisplay.textContent = `已选择文件: ${fileName}`;
            
            resetDisplay();
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    workbook = XLSX.read(data, { type: 'array' });
                    
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });
                    
                    originalData = convertSheetData(jsonData);
                    
                    analyzeBtn.disabled = false;
                    
                    showNotification(`成功加载文件: ${fileName}`, 'success');
                } catch (error) {
                    console.error('Error reading file:', error);
                    showNotification('读取失败，请联网后重新进入系统', 'error');
                }
            };
            
            reader.readAsArrayBuffer(file);
        }
        
        // 转换工作表数据为对象数组
        function convertSheetData(sheetData) {
            if (sheetData.length < 2) return [];
            
            const headers = sheetData[0].map(h => h ? h.toString().trim() : '');
            
            const findColumnIndex = (keywords) => {
                for (let keyword of keywords) {
                    for (let i = 0; i < headers.length; i++) {
                        if (headers[i] && headers[i].toLowerCase().includes(keyword.toLowerCase())) {
                            return i;
                        }
                    }
                }
                return -1;
            };
            
            const orderIdIndex = findColumnIndex(['订单id', '订单', 'id']);
            const lineIndex = findColumnIndex(['线路', '路线', 'line']);
            const plateIndex = findColumnIndex(['车牌', '车牌号码', '车牌号']);
            const contactIndex = findColumnIndex(['联系人', '姓名', '名字']);
            const phoneIndex = findColumnIndex(['电话', '联系电话', '手机']);
            const ticketIndex = findColumnIndex(['票数', '票', '人数']);
            const noticeIndex = findColumnIndex(['通知', '通知内容', '内容']);
            const dateIndex = findColumnIndex(['日期', '乘车日期', '出发日期']);
            const timeIndex = findColumnIndex(['时间', '乘车时间', '出发时间']);
            const pickupIndex = findColumnIndex(['上车', '上车地点', '出发地']);
            const dropoffIndex = findColumnIndex(['下车', '下车地点', '目的地']);
            const managerIndex = findColumnIndex(['负责人', '随车负责人', '车长']);
            const managerPhoneIndex = findColumnIndex(['负责人电话', '车长电话']);
            const notesIndex = findColumnIndex(['注意事项', '注意', '备注']);
            
            const data = [];
            for (let i = 1; i < sheetData.length; i++) {
                const row = sheetData[i];
                if (!row || row.length === 0) continue;
                
                let ticketCount = 1;
                if (ticketIndex >= 0 && row[ticketIndex] !== undefined && row[ticketIndex] !== null && row[ticketIndex] !== '') {
                    const ticketValue = Number(row[ticketIndex]);
                    ticketCount = isNaN(ticketValue) ? 1 : ticketValue;
                }
                
                const rowObj = {
                    订单ID: orderIdIndex >= 0 && row[orderIdIndex] ? row[orderIdIndex].toString() : `ORD${1000 + i}`,
                    线路: lineIndex >= 0 && row[lineIndex] ? row[lineIndex].toString() : `线路${(i % 5) + 1}`,
                    车牌号码: "",
                    联系人: contactIndex >= 0 && row[contactIndex] ? row[contactIndex].toString() : `联系人${i}`,
                    联系电话: phoneIndex >= 0 && row[phoneIndex] ? row[phoneIndex].toString() : `138${String(10000000 + i).substring(1)}`,
                    票数: ticketCount,
                    通知内容: "",
                    乘车日期: dateIndex >= 0 && row[dateIndex] ? row[dateIndex].toString() : getRandomDate(),
                    乘车时间: timeIndex >= 0 && row[timeIndex] ? row[timeIndex].toString() : `${8 + (i % 10)}:${i % 2 === 0 ? '00' : '30'}`,
                    上车地点: pickupIndex >= 0 && row[pickupIndex] ? row[pickupIndex].toString() : `地点${String.fromCharCode(65 + (i % 5))}`,
                    下车地点: dropoffIndex >= 0 && row[dropoffIndex] ? row[dropoffIndex].toString() : `地点${String.fromCharCode(70 + (i % 5))}`,
                    随车负责人: "",
                    随车负责人电话: "",
                    查看注意事项: notesIndex >= 0 && row[notesIndex] ? row[notesIndex].toString() : '切勿迟到，迟到车子就走了'
                };
                
                data.push(rowObj);
            }
            
            return data;
        }
        
        // 生成随机日期
        function getRandomDate() {
            const start = new Date(2023, 0, 1);
            const end = new Date(2023, 11, 31);
            const date = new Date(start.getTime() + Math.random() * (end.getTime() - start.getTime()));
            return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
        }
        
        // 生成示例数据（用于演示）
        function generateSampleData() {
            const sampleData = [];
            const lines = ['线路 1', '线路 2', '线路 3'];
            const pickupLocations = ['出发地 1', '出发地 2', '出发地 3'];
            const dropoffLocations = [' 目的地 1', '目的地 2', '目的地 3'];
            
            for (let lineIndex = 0; lineIndex < lines.length; lineIndex++) {
                const line = lines[lineIndex];
                
                let orderCount;
                if (line === '线路 1') orderCount = 1;
                else if (line === ' 线路 2') orderCount = 1;
                else orderCount = 1;
                
                for (let i = 1; i <= orderCount; i++) {
                    const pickupIndex = Math.floor(Math.random() * pickupLocations.length);
                    const pickup = pickupLocations[pickupIndex];
                    
                    const dropoffIndex = lineIndex % dropoffLocations.length;
                    const dropoff = dropoffLocations[dropoffIndex];
                    
                    const ticketCount = 1;
                    
                    sampleData.push({
                        订单ID: `${1000 + (lineIndex * 100 + i)}`,
                        线路: line,
                        车牌号码: "",
                        联系人: `乘客${lineIndex * 100 + i}`,
                        联系电话: `123${String(10000000 + (lineIndex * 100 + i)).substring(1)}`,
                        票数: ticketCount,
                        通知内容: "",
                        乘车日期: '2025-06-15',
                        乘车时间: `${8 + (i % 5)}:${i % 2 === 0 ? '00' : '30'}`,
                        上车地点: pickup,
                        下车地点: dropoff,
                        随车负责人: "",
                        随车负责人电话: "",
                        查看注意事项: ' 切勿迟到，迟到车就走了'
                    });
                }
            }
            
            return sampleData;
        }
        
        // 显示线路信息填写弹窗
        function showLineInfoModal() {
            if (originalData.length === 0) {
                showNotification('请先上传Excel文件', 'error', true);
                return;
            }
            
            const lines = [...new Set(originalData.map(item => item.线路))].sort();
            
            // 按线路分组，收集每个线路的时间、上车地点、下车地点
            const lineTimeMap = {};
            const linePickupMap = {};
            const lineDropoffMap = {};
            
            lines.forEach(line => {
                // 获取当前线路的所有数据
                const lineData = originalData.filter(item => item.线路 === line);
                
                // 收集当前线路的所有时间（去重、过滤空值、排序）
                const times = [...new Set(lineData.map(item => item.乘车时间).filter(time => time && time.trim()))].sort();
                lineTimeMap[line] = times;
                
                // 收集当前线路的所有上车地点（去重、过滤空值、排序）
                const pickups = [...new Set(lineData.map(item => item.上车地点).filter(pickup => pickup && pickup.trim()))].sort();
                linePickupMap[line] = pickups;
                
                // 收集当前线路的所有下车地点（去重、过滤空值、排序）
                const dropoffs = [...new Set(lineData.map(item => item.下车地点).filter(dropoff => dropoff && dropoff.trim()))].sort();
                lineDropoffMap[line] = dropoffs;
            });
            
            lineInputsBody.innerHTML = '';
            
            lines.forEach((line, index) => {
                const row = document.createElement('tr');
                row.dataset.line = line;
                row.dataset.plate = "";
                
                let lastInfo = null;
                if (lastLineInfo[line] && lastLineInfo[line].length > 0) {
                    lastInfo = lastLineInfo[line][0];
                }
                
                // 获取当前线路的时间选项
                const timeOptions = lineTimeMap[line] || [];
                const timeOptionsHtml = timeOptions.map(time => 
                    `<option value="${time}" ${lastInfo && lastInfo.乘车时间 === time ? 'selected' : ''}>${time}</option>`
                ).join('');
                
                // 获取当前线路的上车地点选项
                const pickupOptions = linePickupMap[line] || [];
                const pickupOptionsHtml = pickupOptions.map(pickup => 
                    `<option value="${pickup}" ${lastInfo && lastInfo.上车地点 === pickup ? 'selected' : ''}>${pickup}</option>`
                ).join('');
                
                // 获取当前线路的下车地点选项
                const dropoffOptions = lineDropoffMap[line] || [];
                const dropoffOptionsHtml = dropoffOptions.map(dropoff => 
                    `<option value="${dropoff}" ${lastInfo && lastInfo.下车地点 === dropoff ? 'selected' : ''}>${dropoff}</option>`
                ).join('');
                
                row.innerHTML = `
                    <td class="line-action-buttons">
                        <button class="add-line-btn" type="button" data-line="${line}">
                            <i class="fas fa-plus"></i>
                        </button>
                        <button class="remove-line-btn" type="button" data-line="${line}" disabled>
                            <i class="fas fa-minus"></i>
                        </button>
                    </td>
                    <td>${line}</td>
                    <td>
                        <select class="input-field time-select" id="time-${index}" data-line="${line}">
                            <option value="">--不限时间--</option>
                            ${timeOptionsHtml}
                        </select>
                    </td>
                    <td>
                        <select class="input-field pickup-select" id="pickup-${index}" data-line="${line}">
                            <option value="">--不限上车地点--</option>
                            ${pickupOptionsHtml}
                        </select>
                    </td>
                    <td>
                        <select class="input-field dropoff-select" id="dropoff-${index}" data-line="${line}">
                            <option value="">--不限下车地点--</option>
                            ${dropoffOptionsHtml}
                        </select>
                    </td>
                    <td>
                        <input type="number" class="input-field" id="count-${index}" data-line="${line}" placeholder="请输入人数" min="0" value="${lastInfo && lastInfo.人数 !== null ? lastInfo.人数 : ''}">
                    </td>
                    <td><input type="text" class="input-field" id="plate-${index}" data-line="${line}" placeholder="请输入车牌号码" value="${lastInfo ? lastInfo.车牌号码 || '' : ''}"></td>
                    <td><input type="text" class="input-field" id="manager-${index}" data-line="${line}" placeholder="请输入随车负责人" value="${lastInfo ? lastInfo.随车负责人 || '' : ''}"></td>
                    <td><input type="text" class="input-field" id="managerPhone-${index}" data-line="${line}" placeholder="请输入负责人电话" value="${lastInfo ? lastInfo.随车负责人电话 || '' : ''}"></td>
                    <td><input type="text" class="input-field" id="notice-${index}" data-line="${line}" placeholder="请输入通知内容" value="${lastInfo ? lastInfo.通知内容 || '' : ''}"></td>
                `;
                lineInputsBody.appendChild(row);
                
                if (lastLineInfo[line] && lastLineInfo[line].length > 1) {
                    for (let i = 1; i < lastLineInfo[line].length; i++) {
                        const extraRow = document.createElement('tr');
                        const extraIndex = index + i;
                        extraRow.dataset.line = line;
                        extraRow.dataset.plate = lastLineInfo[line][i].车牌号码 || "";
                        
                        // 为额外行也使用相同的时间、地点选项
                        const extraTimeOptionsHtml = timeOptions.map(time => 
                            `<option value="${time}" ${lastLineInfo[line][i].乘车时间 === time ? 'selected' : ''}>${time}</option>`
                        ).join('');
                        
                        const extraPickupOptionsHtml = pickupOptions.map(pickup => 
                            `<option value="${pickup}" ${lastLineInfo[line][i].上车地点 === pickup ? 'selected' : ''}>${pickup}</option>`
                        ).join('');
                        
                        const extraDropoffOptionsHtml = dropoffOptions.map(dropoff => 
                            `<option value="${dropoff}" ${lastLineInfo[line][i].下车地点 === dropoff ? 'selected' : ''}>${dropoff}</option>`
                        ).join('');
                        
                        extraRow.innerHTML = `
                            <td class="line-action-buttons">
                                <button class="add-line-btn" type="button" data-line="${line}">
                                    <i class="fas fa-plus"></i>
                                </button>
                                <button class="remove-line-btn" type="button" data-line="${line}">
                                    <i class="fas fa-minus"></i>
                                </button>
                            </td>
                            <td>${line}</td>
                            <td>
                                <select class="input-field time-select" id="time-${extraIndex}" data-line="${line}">
                                    <option value="">--不限时间--</option>
                                    ${extraTimeOptionsHtml}
                                </select>
                            </td>
                            <td>
                                <select class="input-field pickup-select" id="pickup-${extraIndex}" data-line="${line}">
                                    <option value="">--不限上车地点--</option>
                                    ${extraPickupOptionsHtml}
                                </select>
                            </td>
                            <td>
                                <select class="input-field dropoff-select" id="dropoff-${extraIndex}" data-line="${line}">
                                    <option value="">--不限下车地点--</option>
                                    ${extraDropoffOptionsHtml}
                                </select>
                            </td>
                            <td>
                                <input type="number" class="input-field" id="count-${extraIndex}" data-line="${line}" placeholder="请输入人数" min="0" value="${lastLineInfo[line][i].人数 !== null ? lastLineInfo[line][i].人数 : ''}">
                            </td>
                            <td><input type="text" class="input-field" id="plate-${extraIndex}" data-line="${line}" placeholder="请输入车牌号码" value="${lastLineInfo[line][i].车牌号码 || ''}"></td>
                            <td><input type="text" class="input-field" id="manager-${extraIndex}" data-line="${line}" placeholder="请输入随车负责人" value="${lastLineInfo[line][i].随车负责人 || ''}"></td>
                            <td><input type="text" class="input-field" id="managerPhone-${extraIndex}" data-line="${line}" placeholder="请输入负责人电话" value="${lastLineInfo[line][i].随车负责人电话 || ''}"></td>
                            <td><input type="text" class="input-field" id="notice-${extraIndex}" data-line="${line}" placeholder="请输入通知内容" value="${lastLineInfo[line][i].通知内容 || ''}"></td>
                        `;
                        lineInputsBody.appendChild(extraRow);
                    }
                }
            });
            
            updateRemoveButtonsState();
            
            document.querySelectorAll('.add-line-btn').forEach(btn => {
                btn.addEventListener('click', addLineHandler);
            });
            
            document.querySelectorAll('.remove-line-btn').forEach(btn => {
                btn.addEventListener('click', removeLineHandler);
            });
            
            modalOverlay.style.display = 'flex';
        }
        
        // 更新减号按钮状态
        function updateRemoveButtonsState() {
            const rows = document.querySelectorAll('#lineInputsBody tr');
            const lineCounts = {};
            
            rows.forEach(row => {
                const lineCell = row.querySelector('td:nth-child(2)');
                if (lineCell) {
                    const line = lineCell.textContent;
                    lineCounts[line] = (lineCounts[line] || 0) + 1;
                }
            });
            
            rows.forEach(row => {
                const lineCell = row.querySelector('td:nth-child(2)');
                const removeBtn = row.querySelector('.remove-line-btn');
                
                if (lineCell && removeBtn) {
                    const line = lineCell.textContent;
                    removeBtn.disabled = lineCounts[line] <= 1;
                }
            });
        }
        
        // 加号按钮事件处理器
        function addLineHandler() {
            const line = this.getAttribute('data-line');
            const row = this.closest('tr');
            
            // 获取当前线路的时间、上车地点、下车地点选项
            const lineData = originalData.filter(item => item.线路 === line);
            
            // 收集当前线路的所有时间（去重、过滤空值、排序）
            const times = [...new Set(lineData.map(item => item.乘车时间).filter(time => time && time.trim()))].sort();
            const timeOptionsHtml = times.map(time => `<option value="${time}">${time}</option>`).join('');
            
            // 收集当前线路的所有上车地点（去重、过滤空值、排序）
            const pickups = [...new Set(lineData.map(item => item.上车地点).filter(pickup => pickup && pickup.trim()))].sort();
            const pickupOptionsHtml = pickups.map(pickup => `<option value="${pickup}">${pickup}</option>`).join('');
            
            // 收集当前线路的所有下车地点（去重、过滤空值、排序）
            const dropoffs = [...new Set(lineData.map(item => item.下车地点).filter(dropoff => dropoff && dropoff.trim()))].sort();
            const dropoffOptionsHtml = dropoffs.map(dropoff => `<option value="${dropoff}">${dropoff}</option>`).join('');
            
            const newRow = row.cloneNode(true);
            
            const newIndex = document.querySelectorAll('#lineInputsBody tr').length;
            newRow.querySelectorAll('input, select').forEach(input => {
                const oldId = input.id;
                const field = oldId.split('-')[0];
                input.id = `${field}-${newIndex}`;
                if (input.tagName === 'INPUT') {
                    if (input.type === 'text' || input.type === 'number') {
                        input.value = "";
                    }
                } else if (input.tagName === 'SELECT') {
                    input.selectedIndex = 0;
                }
            });
            
            // 替换时间、上车地点、下车地点的选项
            const timeSelect = newRow.querySelector('.time-select');
            const pickupSelect = newRow.querySelector('.pickup-select');
            const dropoffSelect = newRow.querySelector('.dropoff-select');
            
            if (timeSelect) {
                timeSelect.innerHTML = `<option value="">--不限时间--</option>${timeOptionsHtml}`;
            }
            
            if (pickupSelect) {
                pickupSelect.innerHTML = `<option value="">--不限上车地点--</option>${pickupOptionsHtml}`;
            }
            
            if (dropoffSelect) {
                dropoffSelect.innerHTML = `<option value="">--不限下车地点--</option>${dropoffOptionsHtml}`;
            }
            
            const addBtn = newRow.querySelector('.add-line-btn');
            const removeBtn = newRow.querySelector('.remove-line-btn');
            addBtn.addEventListener('click', addLineHandler);
            removeBtn.addEventListener('click', removeLineHandler);
            
            row.parentNode.insertBefore(newRow, row.nextSibling);
            
            updateRemoveButtonsState();
        }
        
        // 减号按钮事件处理器
        function removeLineHandler() {
            const row = this.closest('tr');
            const line = this.getAttribute('data-line');
            
            const lineRows = document.querySelectorAll(`tr td:nth-child(2)`);
            let lineCount = 0;
            
            lineRows.forEach(cell => {
                if (cell.textContent === line) {
                    lineCount++;
                }
            });
            
            if (lineCount > 1) {
                row.remove();
                updateRemoveButtonsState();
            }
        }
        
        // 关闭弹窗
        function closeModal() {
            modalOverlay.style.display = 'none';
        }
        
        // 新增：检查车辆信息是否有重复车牌且人数不同
        function checkVehicleInfoConsistency() {
            const plateInfoMap = new Map(); // 车牌 -> {人数, 线路列表}
            vehicleInfoErrors = [];
            
            const lineRows = document.querySelectorAll('#lineInputsBody tr');
            
            lineRows.forEach((row, rowIndex) => {
                const lineCell = row.querySelector('td:nth-child(2)');
                const countInput = row.querySelector('input[type="number"]');
                const plateInput = row.querySelector('td:nth-child(7) input');
                
                if (lineCell && plateInput) {
                    const line = lineCell.textContent;
                    const plate = plateInput.value.trim();
                    const count = countInput.value.trim() === "" ? null : parseInt(countInput.value);
                    
                    if (plate) { // 只检查有车牌的行
                        if (plateInfoMap.has(plate)) {
                            const existingInfo = plateInfoMap.get(plate);
                            
                            // 检查人数是否一致
                            if (existingInfo.count !== count) {
                                // 记录错误
                                if (!existingInfo.errorAdded) {
                                    vehicleInfoErrors.push({
                                        plate: plate,
                                        lines: [...existingInfo.lines, line],
                                        counts: [existingInfo.count, count]
                                    });
                                    existingInfo.errorAdded = true;
                                } else {
                                    // 如果已经记录过错误，更新线路列表
                                    const error = vehicleInfoErrors.find(e => e.plate === plate);
                                    if (error && !error.lines.includes(line)) {
                                        error.lines.push(line);
                                        error.counts.push(count);
                                    }
                                }
                            } else {
                                // 人数一致，添加线路到列表中
                                if (!existingInfo.lines.includes(line)) {
                                    existingInfo.lines.push(line);
                                }
                            }
                        } else {
                            // 第一次遇到这个车牌
                            plateInfoMap.set(plate, {
                                count: count,
                                lines: [line],
                                errorAdded: false
                            });
                        }
                    }
                }
            });
            
            return vehicleInfoErrors.length === 0;
        }
        
        // 新增：显示车辆信息错误对话框
        function showVehicleErrorDialog() {
            if (vehicleInfoErrors.length === 0) {
                return false;
            }
            
            // 清空错误列表
            vehicleErrorList.innerHTML = '';
            
            // 填充错误列表
            vehicleInfoErrors.forEach((error, index) => {
                const errorItem = document.createElement('div');
                errorItem.className = 'vehicle-error-item';
                
                const countsText = error.counts.map(c => c === null ? '未设置' : `${c}人`).join(', ');
                
                errorItem.innerHTML = `
                    <div>
                        <span class="vehicle-error-plate">${error.plate}</span>
                        <div class="vehicle-error-details">
                            线路: ${error.lines.join(', ')}<br>
                            人数设置: ${countsText}
                        </div>
                    </div>
                `;
                
                vehicleErrorList.appendChild(errorItem);
            });
            
            // 显示错误对话框
            vehicleErrorDialogOverlay.style.display = 'flex';
            
            return true;
        }
        
        // 新增：关闭车辆错误对话框
        function closeVehicleErrorDialog() {
            vehicleErrorDialogOverlay.style.display = 'none';
        }
        
        // 使用线路信息处理数据
        function processDataWithLineInfo() {
            // 首先检查车辆信息是否一致
            if (!checkVehicleInfoConsistency()) {
                // 显示错误对话框
                showVehicleErrorDialog();
                return;
            }
            
            const inputs = document.querySelectorAll('.input-field');
            lineInfo = {};
            vehicleCapacityMap.clear();
            plateLineMap.clear();
            vehicleTotalAssigned.clear(); // 清空车辆总人数跟踪
            
            const lineRows = document.querySelectorAll('#lineInputsBody tr');
            
            // 第一遍：收集所有车辆信息
            const vehicleInfoMap = new Map(); // 车牌 -> 车辆信息
            
            lineRows.forEach((row, rowIndex) => {
                const lineCell = row.querySelector('td:nth-child(2)');
                const timeSelect = row.querySelector('.time-select');
                const pickupSelect = row.querySelector('.pickup-select');
                const dropoffSelect = row.querySelector('.dropoff-select');
                const countInput = row.querySelector('input[type="number"]');
                const plateInput = row.querySelector('td:nth-child(7) input');
                const managerInput = row.querySelector('td:nth-child(8) input');
                const managerPhoneInput = row.querySelector('td:nth-child(9) input');
                const noticeInput = row.querySelector('td:nth-child(10) input');
                
                if (lineCell) {
                    const line = lineCell.textContent;
                    const time = timeSelect ? timeSelect.value.trim() : "";
                    const pickup = pickupSelect ? pickupSelect.value : "";
                    const dropoff = dropoffSelect ? dropoffSelect.value : "";
                    const count = countInput.value.trim() === "" ? null : parseInt(countInput.value);
                    const plate = plateInput.value.trim();
                    const manager = managerInput.value.trim();
                    const managerPhone = managerPhoneInput.value.trim();
                    const notice = noticeInput.value.trim();
                    
                    if (plate) {
                        // 如果这个车牌已经存在，使用已存在的信息（确保一致性）
                        if (vehicleInfoMap.has(plate)) {
                            const existingInfo = vehicleInfoMap.get(plate);
                            
                            // 使用已存在的车辆信息
                            if (!lineInfo[line]) {
                                lineInfo[line] = [];
                            }
                            
                            lineInfo[line].push({
                                乘车时间: time,
                                上车地点: pickup,
                                下车地点: dropoff,
                                人数: existingInfo.count, // 使用已存在的人数
                                车牌号码: plate,
                                随车负责人: manager || existingInfo.manager,
                                随车负责人电话: managerPhone || existingInfo.managerPhone,
                                通知内容: notice || existingInfo.notice,
                                已分配人数: 0
                            });
                        } else {
                            // 第一次遇到这个车牌
                            if (!lineInfo[line]) {
                                lineInfo[line] = [];
                            }
                            
                            lineInfo[line].push({
                                乘车时间: time,
                                上车地点: pickup,
                                下车地点: dropoff,
                                人数: count,
                                车牌号码: plate,
                                随车负责人: manager,
                                随车负责人电话: managerPhone,
                                通知内容: notice,
                                已分配人数: 0
                            });
                            
                            // 保存车辆信息
                            vehicleInfoMap.set(plate, {
                                count: count,
                                manager: manager,
                                managerPhone: managerPhone,
                                notice: notice
                            });
                            
                            // 初始化车辆总人数跟踪
                            vehicleTotalAssigned.set(plate, 0);
                        }
                        
                        // 添加到车辆容量映射
                        if (plate && !vehicleCapacityMap.has(plate)) {
                            vehicleCapacityMap.set(plate, {
                                乘车时间: time,
                                上车地点: pickup,
                                下车地点: dropoff,
                                容量: count,
                                随车负责人: manager,
                                随车负责人电话: managerPhone,
                                通知内容: notice,
                                已分配人数: 0
                            });
                        }
                        
                        if (plate) {
                            if (!plateLineMap.has(plate)) {
                                plateLineMap.set(plate, new Set());
                            }
                            plateLineMap.get(plate).add(line);
                        }
                    } else {
                        // 没有车牌的情况
                        if (!lineInfo[line]) {
                            lineInfo[line] = [];
                        }
                        
                        lineInfo[line].push({
                            乘车时间: time,
                            上车地点: pickup,
                            下车地点: dropoff,
                            人数: count,
                            车牌号码: plate,
                            随车负责人: manager,
                            随车负责人电话: managerPhone,
                            通知内容: notice,
                            已分配人数: 0
                        });
                    }
                }
            });
            
            // 第二遍：处理没有处理的行（比如没有车牌的）
            lineRows.forEach((row, rowIndex) => {
                const lineCell = row.querySelector('td:nth-child(2)');
                const timeSelect = row.querySelector('.time-select');
                const pickupSelect = row.querySelector('.pickup-select');
                const dropoffSelect = row.querySelector('.dropoff-select');
                const countInput = row.querySelector('input[type="number"]');
                const plateInput = row.querySelector('td:nth-child(7) input');
                const managerInput = row.querySelector('td:nth-child(8) input');
                const managerPhoneInput = row.querySelector('td:nth-child(9) input');
                const noticeInput = row.querySelector('td:nth-child(10) input');
                
                if (lineCell) {
                    const line = lineCell.textContent;
                    const time = timeSelect ? timeSelect.value.trim() : "";
                    const pickup = pickupSelect ? pickupSelect.value : "";
                    const dropoff = dropoffSelect ? dropoffSelect.value : "";
                    const count = countInput.value.trim() === "" ? null : parseInt(countInput.value);
                    const plate = plateInput.value.trim();
                    const manager = managerInput.value.trim();
                    const managerPhone = managerPhoneInput.value.trim();
                    const notice = noticeInput.value.trim();
                    
                    // 如果这个行已经处理过（有车牌且已经在第一遍处理），跳过
                    if (plate && vehicleInfoMap.has(plate)) {
                        return;
                    }
                    
                    // 处理没有车牌或者车牌未在第一遍处理的情况
                    if (!lineInfo[line]) {
                        lineInfo[line] = [];
                    }
                    
                    // 检查是否已经添加过（可能在第一遍已经添加了没有车牌的行）
                    const alreadyAdded = lineInfo[line].some(item => 
                        item.乘车时间 === time && 
                        item.上车地点 === pickup && 
                        item.下车地点 === dropoff && 
                        item.车牌号码 === plate
                    );
                    
                    if (!alreadyAdded) {
                        lineInfo[line].push({
                            乘车时间: time,
                            上车地点: pickup,
                            下车地点: dropoff,
                            人数: count,
                            车牌号码: plate,
                            随车负责人: manager,
                            随车负责人电话: managerPhone,
                            通知内容: notice,
                            已分配人数: 0
                        });
                        
                        if (plate) {
                            if (!plateLineMap.has(plate)) {
                                plateLineMap.set(plate, new Set());
                            }
                            plateLineMap.get(plate).add(line);
                        }
                    }
                }
            });
            
            lastLineInfo = JSON.parse(JSON.stringify(lineInfo));
            
            closeModal();
            
            analyzeData();
        }
        
        // 分析数据并按照新的规则整合
        function analyzeData() {
            loading.style.display = 'block';
            
            setTimeout(() => {
                try {
                    colorMap.clear();
                    lineColorMap.clear();
                    colorIndex = 0;
                    vehiclePickupStats = {};
                    lineUnassignedCount = {};
                    plateStats = {};
                    manuallyAssignedOrders.clear();
                    lineManuallyAssignedCount = {};
                    vehicleTotalAssigned.clear(); // 清空车辆总人数跟踪
                    lineTimeLocationData = []; // 清空线路时间地点统计数据
                    
                    const lines = [...new Set(originalData.map(item => item.线路))].sort();
                    lineOrder = lines;
                    lines.forEach(line => {
                        if (!lineColorMap.has(line)) {
                            lineColorMap.set(line, colorPalette[colorIndex % colorPalette.length]);
                            colorIndex++;
                        }
                        lineUnassignedCount[line] = 0;
                        lineManuallyAssignedCount[line] = 0;
                    });
                    
                    processedData = [];
                    
                    const lineTotalTickets = {};
                    originalData.forEach(item => {
                        const line = item.线路;
                        if (!lineTotalTickets[line]) {
                            lineTotalTickets[line] = 0;
                        }
                        lineTotalTickets[line] += (item.票数 || 0);
                    });
                    
                    // 新增：全局车辆已分配人数跟踪（跨线路共享）
                    const vehicleAssignedCount = new Map(); // 车牌 -> 已分配人数（跨线路）
                    
                    Object.keys(lineTotalTickets).forEach(line => {
                        const totalTickets = lineTotalTickets[line];
                        const vehicles = lineInfo[line] || [];
                        
                        if (vehicles.length === 0) {
                            vehicles.push({
                                乘车时间: "",
                                上车地点: "",
                                下车地点: "",
                                人数: null,
                                车牌号码: "",
                                随车负责人: "",
                                随车负责人电话: "",
                                通知内容: "",
                                已分配人数: 0
                            });
                        }
                        
                        const lineOrders = originalData.filter(item => item.线路 === line);
                        
                        // 按照四要素分组：线路、上车地点、下车地点、时间
                        const ordersByFourElements = {};
                        lineOrders.forEach(order => {
                            const key = `${order.线路}|${order.上车地点 || ''}|${order.下车地点 || ''}|${order.乘车时间 || ''}`;
                            if (!ordersByFourElements[key]) {
                                ordersByFourElements[key] = [];
                            }
                            ordersByFourElements[key].push(order);
                        });
                        
                        let totalSpecifiedCapacity = 0;
                        const specifiedVehicles = vehicles.filter(v => v.人数 !== null);
                        specifiedVehicles.forEach(v => {
                            totalSpecifiedCapacity += v.人数;
                        });
                        
                        if (totalSpecifiedCapacity > totalTickets) {
                            showNotification(`警告：线路"${line}"的人数限制(${totalSpecifiedCapacity})大于实际票数(${totalTickets})，请调整人数设置`, 'warning');
                        }
                        
                        vehicles.forEach(v => {
                            v.已分配人数 = 0;
                        });
                        
                        // 第一步：先处理有明确人数限制的车辆
                        specifiedVehicles.forEach(vehicle => {
                            let capacity = vehicle.人数;
                            let assigned = 0;
                            
                            // 新增：检查车辆已分配的总人数（跨线路）
                            const plate = vehicle.车牌号码;
                            if (plate && plate.trim()) {
                                const alreadyAssigned = vehicleAssignedCount.get(plate) || 0;
                                const remainingCapacity = capacity - alreadyAssigned;
                                
                                if (remainingCapacity <= 0) {
                                    // 车辆已满，跳过（这是修复的第一个问题）
                                    console.log(`车牌 ${plate} 已满，跳过分配`);
                                    return;
                                }
                                
                                capacity = remainingCapacity; // 使用剩余容量
                            }
                            
                            const vehicleTime = vehicle.乘车时间 || "";
                            const vehiclePickup = vehicle.上车地点 || "";
                            const vehicleDropoff = vehicle.下车地点 || "";
                            
                            // 获取匹配车辆条件的四要素组
                            const matchingGroups = Object.keys(ordersByFourElements).filter(groupKey => {
                                const [line, pickup, dropoff, time] = groupKey.split('|');
                                
                                if (vehicleTime && time !== vehicleTime) {
                                    return false;
                                }
                                
                                if (vehiclePickup && pickup !== vehiclePickup) {
                                    return false;
                                }
                                
                                if (vehicleDropoff && dropoff !== vehicleDropoff) {
                                    return false;
                                }
                                
                                return true;
                            });
                            
                            // 按组内人数从大到小排序
                            matchingGroups.sort((a, b) => {
                                const aTotal = ordersByFourElements[a].reduce((sum, order) => sum + (order.票数 || 0), 0);
                                const bTotal = ordersByFourElements[b].reduce((sum, order) => sum + (order.票数 || 0), 0);
                                return bTotal - aTotal;
                            });
                            
                            // 改进的分配逻辑：优先分配能凑满的组
                            for (let groupKey of matchingGroups) {
                                if (assigned >= capacity) break;
                                
                                const groupOrders = ordersByFourElements[groupKey];
                                if (!groupOrders || groupOrders.length === 0) continue;
                                
                                const groupTotalTickets = groupOrders.reduce((sum, order) => sum + (order.票数 || 0), 0);
                                
                                // 如果这个组能刚好填满车辆或者填满剩余容量
                                if (groupTotalTickets <= capacity - assigned) {
                                    // 整组分配
                                    groupOrders.forEach(order => {
                                        const processedItem = {
                                            ...order,
                                            车牌号码: vehicle.车牌号码,
                                            随车负责人: vehicle.随车负责人,
                                            随车负责人电话: vehicle.随车负责人电话,
                                            通知内容: vehicle.通知内容 || order.通知内容
                                        };
                                        processedData.push(processedItem);
                                        
                                        assigned += (order.票数 || 0);
                                        vehicle.已分配人数 = assigned;
                                        
                                        // 新增：更新全局车辆已分配人数（跨线路）
                                        if (vehicle.车牌号码 && vehicle.车牌号码.trim()) {
                                            const currentAssigned = vehicleAssignedCount.get(vehicle.车牌号码) || 0;
                                            vehicleAssignedCount.set(vehicle.车牌号码, currentAssigned + (order.票数 || 0));
                                            
                                            if (vehicleCapacityMap.has(vehicle.车牌号码)) {
                                                vehicleCapacityMap.get(vehicle.车牌号码).已分配人数 = currentAssigned + (order.票数 || 0);
                                            }
                                        }
                                    });
                                    
                                    // 从原始数据中移除已分配的订单
                                    delete ordersByFourElements[groupKey];
                                } else {
                                    // 组人数超过剩余容量，尝试部分分配
                                    let remainingInGroup = groupTotalTickets;
                                    const ordersToAssign = [];
                                    const ordersToKeep = [];
                                    
                                    // 按订单票数从大到小排序
                                    const sortedOrders = [...groupOrders].sort((a, b) => (b.票数 || 0) - (a.票数 || 0));
                                    
                                    for (let order of sortedOrders) {
                                        if (assigned >= capacity) {
                                            ordersToKeep.push(order);
                                            continue;
                                        }
                                        
                                        const orderTickets = order.票数 || 0;
                                        if (assigned + orderTickets <= capacity) {
                                            ordersToAssign.push(order);
                                            assigned += orderTickets;
                                            vehicle.已分配人数 = assigned;
                                            
                                            // 新增：更新全局车辆已分配人数（跨线路）
                                            if (vehicle.车牌号码 && vehicle.车牌号码.trim()) {
                                                const currentAssigned = vehicleAssignedCount.get(vehicle.车牌号码) || 0;
                                                vehicleAssignedCount.set(vehicle.车牌号码, currentAssigned + orderTickets);
                                                
                                                if (vehicleCapacityMap.has(vehicle.车牌号码)) {
                                                    vehicleCapacityMap.get(vehicle.车牌号码).已分配人数 = currentAssigned + orderTickets;
                                                }
                                            }
                                        } else {
                                            ordersToKeep.push(order);
                                        }
                                    }
                                    
                                    // 分配符合条件的订单
                                    ordersToAssign.forEach(order => {
                                        const processedItem = {
                                            ...order,
                                            车牌号码: vehicle.车牌号码,
                                            随车负责人: vehicle.随车负责人,
                                            随车负责人电话: vehicle.随车负责人电话,
                                            通知内容: vehicle.通知内容 || order.通知内容
                                        };
                                        processedData.push(processedItem);
                                    });
                                    
                                    // 更新组内剩余订单
                                    if (ordersToKeep.length > 0) {
                                        ordersByFourElements[groupKey] = ordersToKeep;
                                    } else {
                                        delete ordersByFourElements[groupKey];
                                    }
                                }
                            }
                        });
                        
                        // 第二步：处理无明确人数限制的车辆
                        const unspecifiedVehicles = vehicles.filter(v => v.人数 === null);
                        const remainingOrders = [];
                        
                        // 收集所有剩余的订单
                        Object.keys(ordersByFourElements).forEach(groupKey => {
                            const groupOrders = ordersByFourElements[groupKey];
                            if (groupOrders && groupOrders.length > 0) {
                                remainingOrders.push(...groupOrders);
                            }
                        });
                        
                        if (remainingOrders.length > 0) {
                            if (unspecifiedVehicles.length > 0) {
                                // 将剩余订单按照时间分组
                                const ordersByTime = {};
                                remainingOrders.forEach(order => {
                                    const time = order.乘车时间 || '';
                                    if (!ordersByTime[time]) {
                                        ordersByTime[time] = [];
                                    }
                                    ordersByTime[time].push(order);
                                });
                                
                                const times = Object.keys(ordersByTime);
                                
                                times.forEach(time => {
                                    const timeOrders = ordersByTime[time];
                                    let currentVehicleIndex = 0;
                                    
                                    // 先找匹配时间的车辆
                                    let availableVehicles = unspecifiedVehicles.filter(v => 
                                        v.乘车时间 === '' || v.乘车时间 === time
                                    );
                                    
                                    if (availableVehicles.length === 0) {
                                        availableVehicles = unspecifiedVehicles;
                                    }
                                    
                                    timeOrders.forEach(order => {
                                        const vehicle = availableVehicles[currentVehicleIndex % availableVehicles.length];
                                        
                                        const processedItem = {
                                            ...order,
                                            车牌号码: vehicle.车牌号码,
                                            随车负责人: vehicle.随车负责人,
                                            随车负责人电话: vehicle.随车负责人电话,
                                            通知内容: vehicle.通知内容 || order.通知内容
                                        };
                                        processedData.push(processedItem);
                                        
                                        vehicle.已分配人数 += (order.票数 || 0);
                                        
                                        // 新增：更新全局车辆已分配人数（跨线路）
                                        if (vehicle.车牌号码 && vehicle.车牌号码.trim()) {
                                            const currentAssigned = vehicleAssignedCount.get(vehicle.车牌号码) || 0;
                                            vehicleAssignedCount.set(vehicle.车牌号码, currentAssigned + (order.票数 || 0));
                                            
                                            if (vehicleCapacityMap.has(vehicle.车牌号码)) {
                                                vehicleCapacityMap.get(vehicle.车牌号码).已分配人数 = currentAssigned + (order.票数 || 0);
                                            }
                                        }
                                        
                                        currentVehicleIndex++;
                                    });
                                });
                            } else {
                                // 没有无限制车辆，创建未分配车辆
                                const unassignedVehicle = {
                                    乘车时间: "",
                                    上车地点: "",
                                    下车地点: "",
                                    人数: null,
                                    车牌号码: "",
                                    随车负责人: "",
                                    随车负责人电话: "",
                                    通知内容: "",
                                    已分配人数: 0
                                };
                                
                                remainingOrders.forEach(order => {
                                    const processedItem = {
                                        ...order,
                                        车牌号码: unassignedVehicle.车牌号码,
                                        随车负责人: unassignedVehicle.随车负责人,
                                        随车负责人电话: unassignedVehicle.随车负责人电话,
                                        通知内容: unassignedVehicle.通知内容 || order.通知内容
                                    };
                                    processedData.push(processedItem);
                                    
                                    unassignedVehicle.已分配人数 += (order.票数 || 0);
                                });
                                
                                lineUnassignedCount[line] = unassignedVehicle.已分配人数;
                                
                                if (!lineInfo[line]) {
                                    lineInfo[line] = [];
                                }
                                lineInfo[line].push(unassignedVehicle);
                            }
                        }
                        
                        // 第三步：尝试将未分配的订单分配到有剩余容量的车辆中
                        const vehiclesWithCapacity = vehicles.filter(v => v.人数 !== null && v.已分配人数 < v.人数);
                        const unassignedOrdersInLine = processedData.filter(item => 
                            item.线路 === line && (!item.车牌号码 || item.车牌号码.trim() === "")
                        );
                        
                        if (vehiclesWithCapacity.length > 0 && unassignedOrdersInLine.length > 0) {
                            vehiclesWithCapacity.forEach(vehicle => {
                                // 检查车辆剩余容量（考虑跨线路已分配人数）
                                const plate = vehicle.车牌号码;
                                let remainingCapacity = vehicle.人数 - vehicle.已分配人数;
                                
                                if (plate && plate.trim()) {
                                    const alreadyAssigned = vehicleAssignedCount.get(plate) || 0;
                                    const vehicleCapacity = vehicleCapacityMap.has(plate) ? vehicleCapacityMap.get(plate).容量 : vehicle.人数;
                                    remainingCapacity = vehicleCapacity - alreadyAssigned;
                                    
                                    if (remainingCapacity <= 0) {
                                        return; // 车辆已满
                                    }
                                }
                                
                                const vehicleTime = vehicle.乘车时间 || "";
                                const vehiclePickup = vehicle.上车地点 || "";
                                const vehicleDropoff = vehicle.下车地点 || "";
                                
                                const matchingUnassigned = unassignedOrdersInLine.filter(order => {
                                    if (vehicleTime && order.乘车时间 !== vehicleTime) {
                                        return false;
                                    }
                                    
                                    if (vehiclePickup && order.上车地点 !== vehiclePickup) {
                                        return false;
                                    }
                                    
                                    if (vehicleDropoff && order.下车地点 !== vehicleDropoff) {
                                        return false;
                                    }
                                    
                                    return (order.票数 || 0) <= remainingCapacity;
                                });
                                
                                matchingUnassigned.forEach(order => {
                                    const orderIndex = processedData.findIndex(item => item.订单ID === order.订单ID);
                                    if (orderIndex !== -1) {
                                        const orderTickets = order.票数 || 0;
                                        
                                        processedData[orderIndex].车牌号码 = vehicle.车牌号码;
                                        processedData[orderIndex].随车负责人 = vehicle.随车负责人;
                                        processedData[orderIndex].随车负责人电话 = vehicle.随车负责人电话;
                                        processedData[orderIndex].通知内容 = vehicle.通知内容 || order.通知内容;
                                        
                                        vehicle.已分配人数 += orderTickets;
                                        
                                        // 新增：更新全局车辆已分配人数（跨线路）
                                        if (vehicle.车牌号码 && vehicle.车牌号码.trim()) {
                                            const currentAssigned = vehicleAssignedCount.get(vehicle.车牌号码) || 0;
                                            vehicleAssignedCount.set(vehicle.车牌号码, currentAssigned + orderTickets);
                                            
                                            if (vehicleCapacityMap.has(vehicle.车牌号码)) {
                                                vehicleCapacityMap.get(vehicle.车牌号码).已分配人数 = currentAssigned + orderTickets;
                                            }
                                        }
                                        
                                        lineUnassignedCount[line] -= orderTickets;
                                        if (lineUnassignedCount[line] < 0) lineUnassignedCount[line] = 0;
                                    }
                                });
                            });
                        }
                    });
                    
                    // 保存车辆总分配人数到全局变量
                    vehicleAssignedCount.forEach((value, key) => {
                        vehicleTotalAssigned.set(key, value);
                    });
                    
                    processedData.sort((a, b) => {
                        const plateA = a.车牌号码 || "";
                        const plateB = b.车牌号码 || "";
                        const lineA = a.线路;
                        const lineB = b.线路;
                        
                        if (plateA && plateB) {
                            if (plateA !== plateB) {
                                return plateA.localeCompare(plateB);
                            } else {
                                return lineA.localeCompare(lineB);
                            }
                        } else if (plateA && !plateB) {
                            return -1;
                        } else if (!plateA && plateB) {
                            return 1;
                        } else {
                            return lineA.localeCompare(lineB);
                        }
                    });
                    
                    lineUnassignedCount = {};
                    lines.forEach(line => {
                        lineUnassignedCount[line] = 0;
                    });
                    
                    processedData.forEach(item => {
                        const line = item.线路;
                        const plate = item.车牌号码 || "";
                        const ticketCount = item.票数 || 0;
                        
                        if (!plate || plate.trim() === "" || 
                            plate.includes("未分配") || 
                            plate.includes("未匹配") ||
                            plate.includes("未安排") ||
                            plate === "未分配车辆") {
                            lineUnassignedCount[line] += ticketCount;
                        }
                    });
                    
                    isSearchActive = false;
                    filteredData = [];
                    searchResultsInfo.textContent = '';
                    
                    // 清空搜索输入框
                    searchContact.value = '';
                    searchPhone.value = '';
                    searchPlate.value = '';
                    searchLine.value = '';
                    searchPickup.value = '';
                    searchDropoff.value = '';
                    
                    selectedRows.clear();
                    selectAllCheckbox.checked = false;
                    updateModifyButtonState();
                    selectAllPlateBtn.style.display = 'none';
                    selectAllUnassignedBtn.style.display = 'none';
                    
                    displayLineTicketStats();
                    
                    // 新增：显示线路时间地点统计
                    displayLineTimeLocationStats();
                    
                    ticketStatsSection.style.display = 'block';
                    
                    toggleBtn.disabled = false;
                    exportBtn.disabled = false;
                    
                    showNotification('已成功分配各车辆信息', 'success');
                } catch (error) {
                    console.error('Error analyzing data:', error);
                    showNotification('数据处理失败', 'error');
                } finally {
                    loading.style.display = 'none';
                }
            }, 800);
        }
        
        // 切换数据显示
        function toggleDataView() {
            isDataVisible = !isDataVisible;
            
            if (isDataVisible) {
                dataSection.style.display = 'flex';
                toggleBtn.innerHTML = '<i class="fas fa-eye-slash"></i> 隐藏整合后的数据';
                
                displayProcessedData();
                displayVehiclePickupStatsPanel();
                
                ticketStatsSection.classList.add('ticket-stats-down');
            } else {
                dataSection.style.display = 'none';
                toggleBtn.innerHTML = '<i class="fas fa-eye"></i> 显示整合后的数据';
                
                vehiclePickupStatsPanel.style.display = 'none';
                
                ticketStatsSection.classList.remove('ticket-stats-down');
            }
        }
        
        // 显示处理后的数据
        function displayProcessedData() {
            processedDataBody.innerHTML = '';
            
            const dataToDisplay = isSearchActive ? filteredData : processedData;
            
            if (dataToDisplay.length === 0) {
                processedDataBody.innerHTML = '<tr><td colspan="15" style="text-align:center;">没有数据</td></tr>';
                return;
            }
            
            vehiclePickupStats = {};
            plateStats = {};
            
            dataToDisplay.forEach(item => {
                const plate = item.车牌号码 || '未分配车辆';
                const line = item.线路 || '未知线路';
                const pickup = item.上车地点 || '未知上车地点';
                const dropoff = item.下车地点 || '未知下车地点';
                const tickets = item.票数 || 0;
                
                const key = `${plate}|${line}`;
                
                if (!vehiclePickupStats[key]) {
                    vehiclePickupStats[key] = {
                        plate: plate,
                        line: line,
                        stats: {}
                    };
                }
                
                const locationKey = `${pickup}→${dropoff}`;
                if (!vehiclePickupStats[key].stats[locationKey]) {
                    vehiclePickupStats[key].stats[locationKey] = 0;
                }
                
                vehiclePickupStats[key].stats[locationKey] += tickets;
                
                if (!plateStats[plate]) {
                    plateStats[plate] = {
                        total: 0,
                        lines: new Set()
                    };
                }
                plateStats[plate].total += tickets;
                plateStats[plate].lines.add(line);
            });
            
            let currentPlate = '';
            let currentLine = '';
            
            dataToDisplay.forEach((item, index) => {
                const row = document.createElement('tr');
                row.dataset.orderId = item.订单ID;
                row.dataset.line = item.线路;
                row.dataset.plate = item.车牌号码 || '';
                
                if (selectedRows.has(item.订单ID)) {
                    row.classList.add('selected-row');
                }
                
                if (item.车牌号码 !== currentPlate) {
                    currentPlate = item.车牌号码;
                    currentLine = '';
                    
                    const plateSeparatorRow = document.createElement('tr');
                    
                    const isUnassigned = !currentPlate || currentPlate === '未分配车辆';
                    if (isUnassigned) {
                        plateSeparatorRow.className = 'unassigned-plate-group';
                    } else {
                        plateSeparatorRow.className = 'plate-group';
                    }
                    
                    let seatStatus = '';
                    let plateTotal = plateStats[currentPlate] ? plateStats[currentPlate].total : 0;
                    
                    if (currentPlate && vehicleCapacityMap.has(currentPlate)) {
                        const vehicleInfo = vehicleCapacityMap.get(currentPlate);
                        const capacity = vehicleInfo.容量;
                        const vehicleTime = vehicleInfo.乘车时间 || '';
                        const timeInfo = vehicleTime ? `时间:${vehicleTime} ` : '';
                        
                        // 检查车辆总分配人数（跨线路）
                        const totalAssigned = vehicleTotalAssigned.get(currentPlate) || plateTotal;
                        
                        if (capacity !== null) {
                            if (totalAssigned >= capacity) {
                                seatStatus = `<span class="seat-status seat-status-full">满员(${capacity}座, 已分配${totalAssigned}人)</span>`;
                            } else {
                                const emptySeats = capacity - totalAssigned;
                                seatStatus = `<span class="seat-status seat-status-available">${timeInfo}${totalAssigned}/${capacity}人(空${emptySeats}座)</span>`;
                            }
                        } else {
                            seatStatus = `<span class="seat-status seat-status-unlimited">${timeInfo}${totalAssigned}人(未限制)</span>`;
                        }
                    } else {
                        seatStatus = `<span class="seat-status seat-status-unassigned">未分配车辆</span>`;
                    }
                    
                    let lineText = '';
                    if (currentPlate && plateLineMap.has(currentPlate)) {
                        const lines = Array.from(plateLineMap.get(currentPlate));
                        if (lines.length === 1) {
                            lineText = `<span class="line-in-plate">${lines[0]}</span> - `;
                        } else if (lines.length > 1) {
                            lineText = `<span class="line-in-plate">${lines.join(',')}</span> - `;
                        }
                    } else if (plateStats[currentPlate] && plateStats[currentPlate].lines.size > 0) {
                        const lines = Array.from(plateStats[currentPlate].lines);
                        if (lines.length === 1) {
                            lineText = `<span class="line-in-plate">${lines[0]}</span> - `;
                        } else if (lines.length > 1) {
                            lineText = `<span class="line-in-plate">${lines.join(',')}</span> - `;
                        }
                    }
                    
                    const plateText = currentPlate ? `${lineText}车牌号码: ${currentPlate} ${seatStatus}` : `未分配车辆 ${seatStatus}`;
                    
                    const plateCheckboxId = `plate-checkbox-${currentPlate || 'unassigned'}`;
                    plateSeparatorRow.innerHTML = `<td colspan="15" style="background-color: ${isUnassigned ? '#fff5f5' : '#f0f0f0'}; font-weight: bold; padding: 8px;">
                        <div class="plate-header">
                            <input type="checkbox" class="plate-checkbox" id="${plateCheckboxId}" data-plate="${currentPlate || 'unassigned'}">
                            <label for="${plateCheckboxId}" style="cursor: pointer;">${plateText}</label>
                        </div>
                    </td>`;
                    processedDataBody.appendChild(plateSeparatorRow);
                    
                    const plateCheckbox = plateSeparatorRow.querySelector('.plate-checkbox');
                    plateCheckbox.addEventListener('change', function() {
                        const plate = this.getAttribute('data-plate');
                        const plateRows = processedDataBody.querySelectorAll(`tr[data-plate="${plate}"]`);
                        
                        plateRows.forEach(row => {
                            const checkbox = row.querySelector('.row-checkbox');
                            const orderId = row.dataset.orderId;
                            
                            if (this.checked) {
                                checkbox.checked = true;
                                selectedRows.add(orderId);
                                row.classList.add('selected-row');
                            } else {
                                checkbox.checked = false;
                                selectedRows.delete(orderId);
                                row.classList.remove('selected-row');
                                selectAllCheckbox.checked = false;
                            }
                        });
                        
                        updateModifyButtonState();
                    });
                    
                    const key = `${currentPlate}|${item.线路}`;
                    if (vehiclePickupStats[key] && vehiclePickupStats[key].stats) {
                        const statsRow = document.createElement('tr');
                        statsRow.className = 'pickup-stats-row';
                        let statsHTML = '<td colspan="15" class="pickup-stats-cell">';
                        statsHTML += `<strong>上车→下车地点人员统计:</strong> `;
                        
                        const stats = vehiclePickupStats[key].stats;
                        for (let location in stats) {
                            statsHTML += `<span class="location-count">${location}: ${stats[location]}人</span>`;
                        }
                        
                        statsHTML += '</td>';
                        statsRow.innerHTML = statsHTML;
                        processedDataBody.appendChild(statsRow);
                    }
                }
                
                if (item.线路 !== currentLine) {
                    currentLine = item.线路;
                    
                    const lineSeparatorRow = document.createElement('tr');
                    lineSeparatorRow.className = 'line-group';
                    
                    const isUnassigned = !currentPlate || currentPlate === '未分配车辆';
                    
                    if (isUnassigned) {
                        const lineCheckboxId = `line-checkbox-${item.线路}-${currentPlate || 'unassigned'}`;
                        lineSeparatorRow.innerHTML = `<td colspan="15" style="background-color: #f8f8f8; padding: 6px;">
                            <div class="unassigned-line-label">
                                <input type="checkbox" class="unassigned-line-checkbox" id="${lineCheckboxId}" data-line="${item.线路}" data-plate="${currentPlate || ''}">
                                <label for="${lineCheckboxId}">线路: ${item.线路}</label>
                            </div>
                        </td>`;
                        
                        const lineCheckbox = lineSeparatorRow.querySelector('.unassigned-line-checkbox');
                        lineCheckbox.addEventListener('change', function() {
                            const line = this.getAttribute('data-line');
                            const plate = this.getAttribute('data-plate');
                            
                            const lineRows = processedDataBody.querySelectorAll(`tr[data-line="${line}"][data-plate="${plate}"]`);
                            
                            lineRows.forEach(row => {
                                const checkbox = row.querySelector('.row-checkbox');
                                const orderId = row.dataset.orderId;
                                
                                if (this.checked) {
                                    checkbox.checked = true;
                                    selectedRows.add(orderId);
                                    row.classList.add('selected-row');
                                } else {
                                    checkbox.checked = false;
                                    selectedRows.delete(orderId);
                                    row.classList.remove('selected-row');
                                    selectAllCheckbox.checked = false;
                                }
                            });
                            
                            updateModifyButtonState();
                        });
                    } else {
                        lineSeparatorRow.innerHTML = `<td colspan="15" style="background-color: #f8f8f8; padding: 6px; font-weight: bold;">
                            线路: ${item.线路}
                        </td>`;
                    }
                    processedDataBody.appendChild(lineSeparatorRow);
                }
                
                row.style.backgroundColor = lineColorMap.get(item.线路) || '#FFFFFF';
                
                row.innerHTML = `
                    <td style="text-align:center;">
                        <input type="checkbox" class="select-checkbox row-checkbox" data-order-id="${item.订单ID}" ${selectedRows.has(item.订单ID) ? 'checked' : ''}>
                    </td>
                    <td>${item.订单ID}</td>
                    <td><strong>${item.线路}</strong></td>
                    <td>${item.车牌号码 || ""}</td>
                    <td>${item.联系人}</td>
                    <td>${item.联系电话}</td>
                    <td class="ticket-count">${item.票数}</td>
                    <td>${item.乘车日期}</td>
                    <td>${item.乘车时间}</td>
                    <td>${item.上车地点}</td>
                    <td>${item.下车地点}</td>
                    <td>${item.随车负责人 || ""}</td>
                    <td>${item.随车负责人电话 || ""}</td>
                    <td>${item.通知内容}</td>
                    <td>${item.查看注意事项}</td>
                `;
                processedDataBody.appendChild(row);
            });
            
            document.querySelectorAll('.row-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    const orderId = this.getAttribute('data-order-id');
                    const row = this.closest('tr');
                    const line = row.dataset.line;
                    const plate = row.dataset.plate;
                    
                    if (this.checked) {
                        selectedRows.add(orderId);
                        row.classList.add('selected-row');
                    } else {
                        selectedRows.delete(orderId);
                        row.classList.remove('selected-row');
                        selectAllCheckbox.checked = false;
                        
                        const lineCheckbox = document.querySelector(`.unassigned-line-checkbox[data-line="${line}"][data-plate="${plate}"]`);
                        if (lineCheckbox) {
                            lineCheckbox.checked = false;
                        }
                        
                        const plateCheckbox = document.querySelector(`.plate-checkbox[data-plate="${plate}"]`);
                        if (plateCheckbox) {
                            plateCheckbox.checked = false;
                        }
                    }
                    
                    updateModifyButtonState();
                });
            });
            
            updateSelectAllButtons();
        }
        
        // 更新全选按钮的显示状态
        function updateSelectAllButtons() {
            const selectedPlates = new Set();
            const selectedLines = new Set();
            let allUnassigned = true;
            
            selectedRows.forEach(orderId => {
                const row = document.querySelector(`tr[data-order-id="${orderId}"]`);
                if (row) {
                    selectedPlates.add(row.dataset.plate);
                    selectedLines.add(row.dataset.line);
                    
                    if (row.dataset.plate) {
                        allUnassigned = false;
                    }
                }
            });
            
            if (selectedPlates.size === 1 && selectedRows.size > 0 && !allUnassigned) {
                const plate = Array.from(selectedPlates)[0];
                selectAllPlateBtn.style.display = 'inline-flex';
                selectAllPlateBtn.setAttribute('data-plate', plate);
                selectAllPlateBtn.innerHTML = `<i class="fas fa-check-square"></i> 全选${plate}`;
            } else {
                selectAllPlateBtn.style.display = 'none';
            }
            
            if (selectedLines.size === 1 && selectedRows.size > 0 && allUnassigned) {
                const line = Array.from(selectedLines)[0];
                selectAllUnassignedBtn.style.display = 'inline-flex';
                selectAllUnassignedBtn.setAttribute('data-line', line);
                selectAllUnassignedBtn.innerHTML = `<i class="fas fa-check-square"></i> 全选${line}未分配`;
            } else {
                selectAllUnassignedBtn.style.display = 'none';
            }
        }
        
        // 全选当前车牌
        function selectAllCurrentPlate() {
            const plate = selectAllPlateBtn.getAttribute('data-plate');
            if (!plate) return;
            
            const plateRows = processedDataBody.querySelectorAll(`tr[data-plate="${plate}"]`);
            const plateCheckbox = document.querySelector(`.plate-checkbox[data-plate="${plate}"]`);
            
            plateRows.forEach(row => {
                const checkbox = row.querySelector('.row-checkbox');
                const orderId = row.dataset.orderId;
                
                if (checkbox) {
                    checkbox.checked = true;
                    selectedRows.add(orderId);
                    row.classList.add('selected-row');
                }
            });
            
            if (plateCheckbox) {
                plateCheckbox.checked = true;
            }
            
            updateModifyButtonState();
        }
        
        // 全选当前线路的未分配订单
        function selectAllCurrentLineUnassigned() {
            const line = selectAllUnassignedBtn.getAttribute('data-line');
            if (!line) return;
            
            const unassignedRows = processedDataBody.querySelectorAll(`tr[data-line="${line}"][data-plate=""]`);
            
            unassignedRows.forEach(row => {
                const checkbox = row.querySelector('.row-checkbox');
                const orderId = row.dataset.orderId;
                
                if (checkbox) {
                    checkbox.checked = true;
                    selectedRows.add(orderId);
                    row.classList.add('selected-row');
                }
            });
            
            const lineCheckbox = document.querySelector(`.unassigned-line-checkbox[data-line="${line}"]`);
            if (lineCheckbox) {
                lineCheckbox.checked = true;
            }
            
            updateModifyButtonState();
        }
        
        // 显示各车次分组地点统计面板
        function displayVehiclePickupStatsPanel() {
            if (!processedData.length) {
                vehiclePickupStatsPanel.style.display = 'none';
                return;
            }
            
            vehiclePickupStats = {};
            processedData.forEach(item => {
                const plate = item.车牌号码 || '未分配车辆';
                const line = item.线路 || '未知线路';
                const pickup = item.上车地点 || '未知上车地点';
                const dropoff = item.下车地点 || '未知下车地点';
                const tickets = item.票数 || 0;
                
                const key = `${plate}|${line}`;
                
                if (!vehiclePickupStats[key]) {
                    vehiclePickupStats[key] = {
                        plate: plate,
                        line: line,
                        stats: {}
                    };
                }
                
                const locationKey = `${pickup}→${dropoff}`;
                if (!vehiclePickupStats[key].stats[locationKey]) {
                    vehiclePickupStats[key].stats[locationKey] = 0;
                }
                
                vehiclePickupStats[key].stats[locationKey] += tickets;
            });
            
            let statsHTML = `
                <div class="stats-header">
                    <div class="vehicle-pickup-stats-title">
                        <i class="fas fa-bus"></i> 各车次上车→下车地点人数统计
                    </div>
                    <button class="stats-refresh-btn" id="refreshStatsBtn">
                        <i class="fas fa-redo"></i> 刷新统计
                    </button>
                </div>
                
                <div class="stats-search-container">
                    <div class="stats-search-dropdown">
                        <button class="stats-search-dropdown-btn" id="statsSearchDropdownBtn">
                            <span id="statsSearchTypeText">车牌号</span>
                            <i class="fas fa-chevron-down"></i>
                        </button>
                        <div class="stats-search-dropdown-content" id="statsSearchDropdownContent">
                            <div class="stats-search-dropdown-item" data-type="车牌号">车牌号</div>
                            <div class="stats-search-dropdown-item" data-type="线路">线路</div>
                        </div>
                    </div>
                    <input type="text" class="stats-search-input" id="statsSearchInput" placeholder="请输入搜索内容...">
                </div>
            `;
            
            const plateGroups = {};
            
            for (let key in vehiclePickupStats) {
                const plate = vehiclePickupStats[key].plate;
                if (!plateGroups[plate]) {
                    plateGroups[plate] = [];
                }
                plateGroups[plate].push(vehiclePickupStats[key]);
            }
            
            Object.keys(plateGroups).sort().forEach(plate => {
                const vehicles = plateGroups[plate];
                const isUnassigned = plate === '未分配车辆' || plate === '';
                
                let plateTotal = 0;
                vehicles.forEach(vehicle => {
                    for (let location in vehicle.stats) {
                        plateTotal += vehicle.stats[location];
                    }
                });
                
                let capacityInfo = '';
                if (plate && vehicleCapacityMap.has(plate)) {
                    const vehicleInfo = vehicleCapacityMap.get(plate);
                    const capacity = vehicleInfo.容量;
                    const vehicleTime = vehicleInfo.乘车时间 || '';
                    const timeInfo = vehicleTime ? `时间:${vehicleTime} ` : '';
                    
                    // 使用车辆总分配人数（跨线路）
                    const totalAssigned = vehicleTotalAssigned.get(plate) || plateTotal;
                    
                    if (capacity !== null) {
                        if (totalAssigned >= capacity) {
                            capacityInfo = `<div style="margin-top:5px; font-size:0.85rem;"><span class="full-status">满员(${capacity}座, 已分配${totalAssigned}人)</span></div>`;
                        } else {
                            const emptySeats = capacity - totalAssigned;
                            capacityInfo = `<div style="margin-top:5px; font-size:0.85rem;"><span class="available-status">${timeInfo}${totalAssigned}/${capacity}人(空${emptySeats}座)</span></div>`;
                        }
                    } else {
                        capacityInfo = `<div style="margin-top:5px; font-size:0.85rem;"><span class="warning-status">${timeInfo}${totalAssigned}人(未限制)</span></div>`;
                    }
                } else if (isUnassigned) {
                    capacityInfo = `<div style="margin-top:5px; font-size:0.85rem;"><span class="unassigned-label">未分配车辆</span></div>`;
                }
                
                let lineText = '';
                if (plate && plateLineMap.has(plate)) {
                    const lines = Array.from(plateLineMap.get(plate));
                    if (lines.length === 1) {
                        lineText = `<span class="line-in-plate">${lines[0]}</span> - `;
                    } else if (lines.length > 1) {
                        lineText = `<span class="line-in-plate">${lines.join(',')}</span> - `;
                    }
                } else if (plate && plateStats[plate] && plateStats[plate].lines.size > 0) {
                    const lines = Array.from(plateStats[plate].lines);
                    if (lines.length === 1) {
                        lineText = `<span class="line-in-plate">${lines[0]}</span> - `;
                    } else if (lines.length > 1) {
                        lineText = `<span class="line-in-plate">${lines.join(',')}</span> - `;
                    }
                }
                
                const plateTitle = plate ? `${lineText}车牌号码: ${plate}` : '未分配车辆';
                statsHTML += `
                    <div class="line-group-title" data-plate="${plate}" data-line="${vehicles.map(v => v.line).join(',')}">
                        <i class="fas fa-car"></i> ${plateTitle} ${capacityInfo}
                    </div>
                    <div class="vehicle-pickup-stats-grid">
                `;
                
                vehicles.forEach(vehicle => {
                    const plateName = vehicle.plate || '未分配车辆';
                    const lineName = vehicle.line;
                    
                    let totalCount = 0;
                    for (let location in vehicle.stats) {
                        totalCount += vehicle.stats[location];
                    }
                    
                    const isUnassigned = plateName === '未分配车辆' || plateName === '';
                    
                    const isManuallyAssigned = plateName && manuallyAssignedOrders.size > 0 && 
                        Array.from(manuallyAssignedOrders).some(orderId => {
                            const order = processedData.find(item => item.订单ID === orderId);
                            return order && order.车牌号码 === plateName && order.线路 === lineName;
                        });
                    
                    const manuallyAssignedClass = isManuallyAssigned ? 'manually-assigned-box' : '';
                    const manuallyAssignedText = isManuallyAssigned ? `<div class="manual-assignment-text">${totalCount}人乘坐${plateName}</div>` : '';
                    
                    const locationScrollContent = Object.keys(vehicle.stats).map(location => {
                        return `<div class="pickup-stat-item">
                            <span class="pickup-location">${location}</span>
                            <span class="pickup-count ${isUnassigned ? 'unassigned-count' : ''}">${vehicle.stats[location]}人</span>
                        </div>`;
                    }).join('');
                    
                    statsHTML += `
                        <div class="vehicle-stat-item ${isUnassigned ? 'unassigned-stat-item' : ''} ${manuallyAssignedClass}" style="${isManuallyAssigned ? 'border: 2px solid #e74c3c !important; box-shadow: 0 0 5px rgba(231, 76, 60, 0.5);' : ''}" data-plate="${plateName}" data-line="${lineName}">
                            <div class="vehicle-title ${isUnassigned ? 'unassigned-title' : ''} ${isManuallyAssigned ? 'manually-assigned-label' : ''}">
                                <span class="vehicle-plate">${lineName}</span>
                            </div>
                            <div class="vehicle-pickup-stats">
                                <div class="location-scroll">
                                    ${locationScrollContent}
                                </div>
                            </div>
                            <div class="vehicle-total">
                                <span class="vehicle-total-label ${isUnassigned ? 'unassigned-label' : ''}">总人数</span>
                                <span class="vehicle-total-count ${isUnassigned ? 'unassigned-count' : ''}">${totalCount}人</span>
                            </div>
                            ${manuallyAssignedText}
                        </div>
                    `;
                });
                
                statsHTML += '</div>';
            });
            
            vehiclePickupStatsPanel.innerHTML = statsHTML;
            vehiclePickupStatsPanel.style.display = 'block';
            
            // 设置车辆统计搜索功能
            setupStatsSearch();
            
            // 设置刷新按钮事件
            const refreshStatsBtn = document.getElementById('refreshStatsBtn');
            if (refreshStatsBtn) {
                refreshStatsBtn.addEventListener('click', function() {
                    // 重新计算车辆统计
                    displayVehiclePickupStatsPanel();
                    showNotification('车辆统计已刷新', 'success');
                });
            }
        }
        
        // 设置车辆统计搜索功能
        function setupStatsSearch() {
            const statsSearchDropdownBtn = document.getElementById('statsSearchDropdownBtn');
            const statsSearchDropdownContent = document.getElementById('statsSearchDropdownContent');
            const statsSearchTypeText = document.getElementById('statsSearchTypeText');
            const statsSearchInput = document.getElementById('statsSearchInput');
            
            if (!statsSearchDropdownBtn) return;
            
            let statsSearchType = '车牌号';
            
            // 设置下拉菜单
            document.querySelectorAll('.stats-search-dropdown-item').forEach(item => {
                item.addEventListener('click', function() {
                    statsSearchType = this.getAttribute('data-type');
                    statsSearchTypeText.textContent = statsSearchType;
                    statsSearchDropdownContent.classList.remove('show');
                    
                    // 触发搜索
                    filterStatsItems();
                });
            });
            
            statsSearchDropdownBtn.addEventListener('click', function() {
                statsSearchDropdownContent.classList.toggle('show');
            });
            
            // 点击外部关闭下拉菜单
            document.addEventListener('click', function(e) {
                if (!statsSearchDropdownBtn.contains(e.target) && !statsSearchDropdownContent.contains(e.target)) {
                    statsSearchDropdownContent.classList.remove('show');
                }
            });
            
            // 输入框搜索
            statsSearchInput.addEventListener('input', filterStatsItems);
            
            // 过滤车辆统计项
            function filterStatsItems() {
                const searchTerm = document.getElementById('statsSearchInput').value.trim().toLowerCase();
                const searchType = statsSearchType;
                
                if (!searchTerm) {
                    // 显示所有
                    document.querySelectorAll('.vehicle-stat-item, .line-group-title').forEach(item => {
                        item.classList.remove('filtered-out');
                    });
                    
                    // 移除之前的无结果提示
                    const existingNoResults = vehiclePickupStatsPanel.querySelector('.no-results');
                    if (existingNoResults) {
                        existingNoResults.remove();
                    }
                    return;
                }
                
                let hasResults = false;
                
                // 隐藏所有车辆统计项
                document.querySelectorAll('.vehicle-stat-item, .line-group-title').forEach(item => {
                    item.classList.add('filtered-out');
                });
                
                // 根据搜索类型显示匹配的项
                if (searchType === '车牌号') {
                    document.querySelectorAll('.line-group-title').forEach(title => {
                        const plate = title.getAttribute('data-plate');
                        if (plate && plate.toLowerCase().includes(searchTerm)) {
                            title.classList.remove('filtered-out');
                            
                            // 显示该车牌下的所有车辆项
                            const plateName = title.getAttribute('data-plate');
                            document.querySelectorAll(`.vehicle-stat-item[data-plate="${plateName}"]`).forEach(item => {
                                item.classList.remove('filtered-out');
                            });
                            
                            hasResults = true;
                        }
                    });
                } else if (searchType === '线路') {
                    document.querySelectorAll('.vehicle-stat-item').forEach(item => {
                        const line = item.getAttribute('data-line');
                        if (line && line.toLowerCase().includes(searchTerm)) {
                            item.classList.remove('filtered-out');
                            
                            // 显示对应的车牌标题
                            const plate = item.getAttribute('data-plate');
                            document.querySelectorAll(`.line-group-title[data-plate="${plate}"]`).forEach(title => {
                                title.classList.remove('filtered-out');
                            });
                            
                            hasResults = true;
                        }
                    });
                }
                
                // 如果没有结果，显示提示
                const existingNoResults = vehiclePickupStatsPanel.querySelector('.no-results');
                if (!hasResults) {
                    if (!existingNoResults) {
                        const noResults = document.createElement('div');
                        noResults.className = 'no-results';
                        noResults.textContent = `未找到匹配"${searchTerm}"的${searchType}`;
                        vehiclePickupStatsPanel.appendChild(noResults);
                    }
                } else if (existingNoResults) {
                    existingNoResults.remove();
                }
            }
        }
        
        // 显示线路票数统计
        function displayLineTicketStats() {
            const lineTicketStats = {};
            
            processedData.forEach(item => {
                const line = item.线路;
                if (!lineTicketStats[line]) {
                    lineTicketStats[line] = 0;
                }
                lineTicketStats[line] += (item.票数 || 0);
            });
            
            const totalTickets = Object.values(lineTicketStats).reduce((sum, tickets) => sum + tickets, 0);
            
            let lineStatsHTML = `
                <div class="line-stats-title">
                    <i class="fas fa-users"></i> 各线路票数统计
                    <button id="toggleLineStatsBtn" class="toggle-line-stats-btn">
                        <i class="fas fa-eye-slash"></i> 隐藏
                    </button>
                </div>
                <div class="line-stats-content" id="lineStatsContent">
                    <div class="line-stats-grid">
            `;
            
            const lines = lineOrder.length > 0 ? lineOrder : [...new Set(processedData.map(item => item.线路))].sort();
            
            lines.forEach(line => {
                const tickets = lineTicketStats[line] || 0;
                
                const vehicles = lineInfo[line] || [];
                let vehicleInfo = '';
                if (vehicles.length > 0) {
                    vehicleInfo = `<br><span style="font-size:0.95rem;">${vehicles.length}辆车`;
                    vehicles.forEach((vehicle, index) => {
                        const capacity = vehicle.人数 === null ? '未限制' : `${vehicle.人数}人限制`;
                        const timeInfo = vehicle.乘车时间 ? `时间:${vehicle.乘车时间}, ` : '';
                        const pickupInfo = vehicle.上车地点 ? `上:${vehicle.上车地点}, ` : '';
                        const dropoffInfo = vehicle.下车地点 ? `下:${vehicle.下车地点}, ` : '';
                        const assigned = vehicle.已分配人数 || 0;
                        
                        let statusText = "";
                        if (vehicle.人数 !== null) {
                            if (assigned >= vehicle.人数) {
                                statusText = `车${index+1}:满员(${vehicle.人数}座)`;
                            } else {
                                const emptySeats = vehicle.人数 - assigned;
                                statusText = `车${index+1}:${timeInfo}${pickupInfo}${dropoffInfo}${assigned}/${vehicle.人数}人(空${emptySeats}座)`;
                            }
                        } else {
                            statusText = `车${index+1}:${timeInfo}${pickupInfo}${dropoffInfo}${assigned}人(未限制)`;
                        }
                        
                        vehicleInfo += `，${statusText}`;
                    });
                    vehicleInfo += '</span>';
                }
                
                const unassignedCount = lineUnassignedCount[line] || 0;
                
                lineStatsHTML += `
                    <div class="line-stat-item" data-line="${line}">
                        <div class="line-name">${line}</div>
                        <div class="line-count">${tickets} 人</div>
                        <div class="line-label">${vehicleInfo}</div>
                    </div>
                `;
            });
            
            lineStatsHTML += `
                    </div>
                    <div class="total-tickets">
                        <div class="total-tickets-value">${totalTickets} 人</div>
                        <div class="total-tickets-label">总票数</div>
                    </div>
                </div>
            `;
            
            lineStatsPanel.innerHTML = lineStatsHTML;
            
            // 添加显示/隐藏按钮事件监听器
            const toggleLineStatsBtn = document.getElementById('toggleLineStatsBtn');
            const lineStatsContent = document.getElementById('lineStatsContent');
            
            if (toggleLineStatsBtn && lineStatsContent) {
                toggleLineStatsBtn.addEventListener('click', function() {
                    lineStatsVisible = !lineStatsVisible;
                    
                    if (lineStatsVisible) {
                        lineStatsContent.style.display = 'block';
                        toggleLineStatsBtn.innerHTML = '<i class="fas fa-eye-slash"></i> 隐藏';
                        toggleLineStatsBtn.style.backgroundColor = '#3498db';
                    } else {
                        lineStatsContent.style.display = 'none';
                        toggleLineStatsBtn.innerHTML = '<i class="fas fa-eye"></i> 显示';
                        toggleLineStatsBtn.style.backgroundColor = '#2ecc71';
                    }
                });
            }
        }
        
        // 新增：显示线路时间地点统计
        function displayLineTimeLocationStats() {
            // 清空现有数据
            lineTimeLocationData = [];
            lineTimeLocationBody.innerHTML = '';
            
            if (processedData.length === 0) {
                lineTimeLocationPanel.style.display = 'none';
                return;

                // 显示面板后，确保底部拖拽区域可见
                lineTimeLocationPanel.style.display = 'flex';
                
                // 确保表格容器的初始高度设置正确
                const headerHeight = lineTimeLocationPanel.querySelector('.line-time-location-header').offsetHeight;
                const searchHeight = lineTimeLocationPanel.querySelector('.line-time-location-search').offsetHeight;
                const panelHeight = parseInt(getComputedStyle(lineTimeLocationPanel).height, 10);
                const tableContainerHeight = panelHeight - headerHeight - searchHeight - 40;
                lineTimeLocationTableContainer.style.maxHeight = Math.max(100, tableContainerHeight) + 'px';
            }
            
            // 按线路、时间、上车地点、下车地点分组统计
            const statsMap = {};
            
            processedData.forEach(item => {
                const line = item.线路 || '未知线路';
                const time = item.乘车时间 || '未指定时间';
                const pickup = item.上车地点 || '未指定上车地点';
                const dropoff = item.下车地点 || '未指定下车地点';
                const tickets = item.票数 || 0;
                
                const key = `${line}|${time}|${pickup}|${dropoff}`;
                
                if (!statsMap[key]) {
                    statsMap[key] = {
                        线路: line,
                        时间: time,
                        上车地点: pickup,
                        下车地点: dropoff,
                        票数: 0
                    };
                }
                
                statsMap[key].票数 += tickets;
            });
            
            // 转换为数组并按线路、时间排序
            lineTimeLocationData = Object.values(statsMap).sort((a, b) => {
                if (a.线路 !== b.线路) return a.线路.localeCompare(b.线路);
                if (a.时间 !== b.时间) return a.时间.localeCompare(b.时间);
                if (a.上车地点 !== b.上车地点) return a.上车地点.localeCompare(b.上车地点);
                return a.下车地点.localeCompare(b.下车地点);
            });
            
            // 填充表格
            if (lineTimeLocationData.length === 0) {
                lineTimeLocationBody.innerHTML = '<tr><td colspan="5" style="text-align:center;">暂无统计数据</td></tr>';
            } else {
                lineTimeLocationData.forEach(item => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${item.线路}</td>
                        <td>${item.时间}</td>
                        <td>${item.上车地点}</td>
                        <td>${item.下车地点}</td>
                        <td style="font-weight:bold; color:#27ae60;">${item.票数} 人</td>
                    `;
                    lineTimeLocationBody.appendChild(row);
                });
            }
            
            // 显示面板
            lineTimeLocationPanel.style.display = 'flex';
            
            // 清空搜索框
            lineTimeLocationSearch.value = '';
        }
        
        // 新增：过滤线路时间地点数据
        function filterLineTimeLocationData() {
            const searchTerm = lineTimeLocationSearch.value.trim().toLowerCase();
            
            if (!searchTerm) {
                // 显示所有数据
                lineTimeLocationBody.innerHTML = '';
                lineTimeLocationData.forEach(item => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${item.线路}</td>
                        <td>${item.时间}</td>
                        <td>${item.上车地点}</td>
                        <td>${item.下车地点}</td>
                        <td style="font-weight:bold; color:#27ae60;">${item.票数} 人</td>
                    `;
                    lineTimeLocationBody.appendChild(row);
                });
                return;
            }
            
            // 过滤数据
            const filteredData = lineTimeLocationData.filter(item => 
                item.线路.toLowerCase().includes(searchTerm)
            );
            
            // 显示过滤后的数据
            lineTimeLocationBody.innerHTML = '';
            
            if (filteredData.length === 0) {
                lineTimeLocationBody.innerHTML = '<tr><td colspan="5" style="text-align:center;">未找到匹配线路的数据</td></tr>';
            } else {
                filteredData.forEach(item => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${item.线路}</td>
                        <td>${item.时间}</td>
                        <td>${item.上车地点}</td>
                        <td>${item.下车地点}</td>
                        <td style="font-weight:bold; color:#27ae60;">${item.票数} 人</td>
                    `;
                    lineTimeLocationBody.appendChild(row);
                });
            }
        }
        
                    // 新增：底部拖拽区域元素
            const bottomResizeArea = document.getElementById('bottomResizeArea');

            // 新增：为底部拖拽区域添加事件监听
            if (bottomResizeArea) {
                bottomResizeArea.addEventListener('mousedown', startResize);
            }

        // 新增：开始调整大小
        function startResize(e) {
            isResizing = true;
            startY = e.clientY;
            startHeight = parseInt(getComputedStyle(lineTimeLocationPanel).height, 10);
            
            document.addEventListener('mousemove', resize);
            document.addEventListener('mouseup', stopResize);
            
            // 阻止文本选择
            e.preventDefault();
        }
        
        // 新增：调整大小
        function resize(e) {
            if (!isResizing) return;
            
            const deltaY = e.clientY - startY;
            let newHeight = startHeight + deltaY;
            
            // 限制最小和最大高度
            const minHeight = 200;
            const maxHeight = window.innerHeight * 0.8; // 最大为视口高度的80%
            
            newHeight = Math.max(minHeight, Math.min(newHeight, maxHeight));
            
            lineTimeLocationPanel.style.height = newHeight + 'px';
            
            // 更新表格容器的高度
            const headerHeight = lineTimeLocationPanel.querySelector('.line-time-location-header').offsetHeight;
            const searchHeight = lineTimeLocationPanel.querySelector('.line-time-location-search').offsetHeight;
            const tableContainerHeight = newHeight - headerHeight - searchHeight - 40; // 减去内边距
            lineTimeLocationTableContainer.style.maxHeight = Math.max(100, tableContainerHeight) + 'px';
        }
        
        // 新增：停止调整大小
        function stopResize() {
            isResizing = false;
            document.removeEventListener('mousemove', resize);
            document.removeEventListener('mouseup', stopResize);
        }
        

        
        // 新增：显示导出排序选择对话框
        function showExportSortDialog() {
            if (processedData.length === 0) {
                showNotification('没有可导出的数据', 'error');
                return;
            }
            
            // 设置默认选项
            document.getElementById('sortByLine').checked = exportSortType === 'line';
            document.getElementById('sortByCampus').checked = exportSortType === 'campus';
            
            exportSortDialogOverlay.style.display = 'flex';
        }
        
        // 新增：关闭导出排序对话框
        function closeExportSortDialog() {
            exportSortDialogOverlay.style.display = 'none';
        }
        
        // 新增：确认导出排序方式
        function confirmExportSort() {
            const selectedSort = document.querySelector('input[name="exportSort"]:checked');
            if (selectedSort) {
                exportSortType = selectedSort.value;
                closeExportSortDialog();
                exportData();
            } else {
                showNotification('请选择排序方式', 'error');
            }
        }
        
        // 导出数据为Excel文件
        function exportData() {
            if (processedData.length === 0) {
                showNotification('没有可导出的数据', 'error');
                return;
            }
            
            try {
                const sheetData = [];
                
                sheetData.push({
                    '订单ID': '订单ID',
                    '线路': '线路',
                    '车牌号码': '车牌号码',
                    '联系人': '联系人',
                    '联系电话': '联系电话',
                    '票数': '票数',
                    '乘车日期': '乘车日期',
                    '乘车时间': '乘车时间',
                    '上车地点': '上车地点',
                    '下车地点': '下车地点',
                    '随车负责人': '随车负责人',
                    '随车负责人电话': '随车负责人电话',
                    '通知内容': '通知内容',
                    '查看注意事项': '查看注意事项'
                });
                
                const plateGroups = {};
                processedData.forEach(item => {
                    const plate = item.车牌号码 || '未分配车辆';
                    if (!plateGroups[plate]) {
                        plateGroups[plate] = [];
                    }
                    plateGroups[plate].push(item);
                });
                
                const plates = Object.keys(plateGroups).sort((a, b) => {
                    if (a === '未分配车辆' || a === '') return 1;
                    if (b === '未分配车辆' || b === '') return -1;
                    return a.localeCompare(b);
                });
                
                let firstGroup = true;
                plates.forEach(plate => {
                    if (!firstGroup) {
                        sheetData.push({});
                    }
                    firstGroup = false;
                    
                    // 根据选择的排序方式对组内数据进行排序
                    let groupData = plateGroups[plate];
                    
                    if (exportSortType === 'line') {
                        // 按线路排序
                        groupData.sort((a, b) => {
                            const lineA = a.线路 || '';
                            const lineB = b.线路 || '';
                            return lineA.localeCompare(lineB);
                        });
                    } else if (exportSortType === 'campus') {
                        // 按校区（上车地点）排序
                        groupData.sort((a, b) => {
                            const pickupA = a.上车地点 || '';
                            const pickupB = b.上车地点 || '';
                            return pickupA.localeCompare(pickupB);
                        });
                    }
                    
                    groupData.forEach(item => {
                        sheetData.push({
                            '订单ID': item.订单ID,
                            '线路': item.线路,
                            '车牌号码': item.车牌号码 || "",
                            '联系人': item.联系人,
                            '联系电话': item.联系电话,
                            '票数': item.票数,
                            '乘车日期': item.乘车日期,
                            '乘车时间': item.乘车时间,
                            '上车地点': item.上车地点,
                            '下车地点': item.下车地点,
                            '随车负责人': item.随车负责人 || "",
                            '随车负责人电话': item.随车负责人电话 || "",
                            '通知内容': item.通知内容,
                            '查看注意事项': item.查看注意事项
                        });
                    });
                });
                
                const worksheet = XLSX.utils.json_to_sheet(sheetData, {skipHeader: true});
                
                const colWidths = [
                    { wch: 10 },
                    { wch: 8 },
                    { wch: 12 },
                    { wch: 8 },
                    { wch: 12 },
                    { wch: 8 },
                    { wch: 12 },
                    { wch: 10 },
                    { wch: 10 },
                    { wch: 15 },
                    { wch: 15 },
                    { wch: 10 },
                    { wch: 12 },
                    { wch: 20 },
                    { wch: 15 }
                ];
                worksheet['!cols'] = colWidths;
                
                const range = XLSX.utils.decode_range(worksheet['!ref']);
                
                for (let col = range.s.c; col <= range.e.c; col++) {
                    const cellAddress = XLSX.utils.encode_cell({ r: 0, c: col });
                    if (!worksheet[cellAddress]) continue;
                    
                    if (!worksheet[cellAddress].s) worksheet[cellAddress].s = {};
                    worksheet[cellAddress].s.fill = {
                        patternType: "solid",
                        fgColor: { rgb: "4A6491" }
                    };
                    worksheet[cellAddress].s.font = {
                        name: '微软雅黑',
                        sz: 11,
                        bold: true,
                        color: { rgb: "FFFFFF" }
                    };
                    worksheet[cellAddress].s.alignment = {
                        vertical: "center",
                        horizontal: "center"
                    };
                }
                
                let currentRow = 1;
                
                plates.forEach(plate => {
                    const groupData = plateGroups[plate];
                    
                    groupData.forEach(item => {
                        const color = lineColorMap.get(item.线路);
                        if (color) {
                            const excelColor = color.replace('#', '');
                            
                            for (let c = range.s.c; c <= range.e.c; c++) {
                                const cellAddress = XLSX.utils.encode_cell({ r: currentRow, c: c });
                                if (!worksheet[cellAddress]) continue;
                                
                                if (!worksheet[cellAddress].s) worksheet[cellAddress].s = {};
                                worksheet[cellAddress].s.fill = {
                                    patternType: "solid",
                                    fgColor: { rgb: excelColor }
                                };
                                worksheet[cellAddress].s.font = {
                                    name: '微软雅黑',
                                    sz: 11
                                };
                            }
                        }
                        currentRow++;
                    });
                    
                    currentRow++;
                });
                
                const newWorkbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(newWorkbook, worksheet, '线路订单整合数据');
                
                const sortText = exportSortType === 'line' ? '按线路' : '按校区';
                const exportFileName = fileName ? 
                    `整合后的_${fileName.replace(/\.[^/.]+$/, "")}_按车牌分组_${sortText}排序.xlsx` : 
                    `线路订单整合数据_按车牌分组_${sortText}排序.xlsx`;
                
                XLSX.writeFile(newWorkbook, exportFileName);
                
                showNotification(`文件已导出: ${exportFileName}`, 'success');
                showNotification(`已按${sortText}排序导出文件`, 'info');
            } catch (error) {
                console.error('Error exporting data:', error);
                showNotification('导出文件失败: ' + error.message, 'error');
            }
        }
        
        // 重置显示
        function resetDisplay() {
            originalData = [];
            processedData = [];
            filteredData = [];
            processedDataBody.innerHTML = '<tr><td colspan="15" style="text-align:center;">请先上传并分析数据</td></tr>';
            ticketStatsSection.style.display = 'none';
            ticketStatsSection.classList.remove('ticket-stats-down');
            dataSection.style.display = 'none';
            vehiclePickupStatsPanel.style.display = 'none';
            lineTimeLocationPanel.style.display = 'none';
            isDataVisible = false;
            isSearchActive = false;
            analyzeBtn.disabled = true;
            toggleBtn.disabled = true;
            toggleBtn.innerHTML = '<i class="fas fa-eye"></i> 显示整合后的数据';
            exportBtn.disabled = true;
            lineInfo = {};
            vehiclePickupStats = {};
            lineOrder = [];
            selectedRows.clear();
            selectAllCheckbox.checked = false;
            searchResultsInfo.textContent = '';
            
            // 清空搜索输入框
            searchContact.value = '';
            searchPhone.value = '';
            searchPlate.value = '';
            searchLine.value = '';
            searchPickup.value = '';
            searchDropoff.value = '';
            
            updateModifyButtonState();
            lineUnassignedCount = {};
            vehicleCapacityMap.clear();
            plateStats = {};
            selectAllPlateBtn.style.display = 'none';
            selectAllUnassignedBtn.style.display = 'none';
            manuallyAssignedOrders.clear();
            lineManuallyAssignedCount = {};
            plateLineMap.clear();
            vehicleTotalAssigned.clear(); // 清空车辆总人数跟踪
            
            // 清空车辆信息错误
            vehicleInfoErrors = [];
            
            // 清空线路时间地点统计数据
            lineTimeLocationData = [];
            lineTimeLocationBody.innerHTML = '';
            
            // 重置线路统计面板显示状态
            lineStatsVisible = true;
        }
        
        // 新增：显示刷新确认对话框
        function showRefreshConfirm() {
            confirmDialogOverlay.style.display = 'flex';
        }
        
        // 新增：关闭确认对话框
        function closeConfirmDialog() {
            confirmDialogOverlay.style.display = 'none';
        }
        
        // 新增：确认刷新
        function confirmRefresh() {
            closeConfirmDialog();
            
            // 执行刷新操作
            fileInput.value = '';
            fileNameDisplay.textContent = '';
            
            resetDisplay();
            
            colorMap.clear();
            lineColorMap.clear();
            colorIndex = 0;
            
            lastLineInfo = {};
            
            originalData = generateSampleData();
            
            analyzeBtn.disabled = false;
            
            showNotification('页面已刷新，可以重新上传文件或使用示例数据进行分析', 'info');
        }
        
        // 显示通知
        function showNotification(message, type, center = false) {
            const oldNotifications = document.querySelectorAll('.notification');
            oldNotifications.forEach(notification => {
                notification.style.animation = 'slideOut 0.3s ease-out';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            });
            
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            if (center) {
                notification.classList.add('center');
            }
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease-out';
                setTimeout(() => {
                    if (notification.parentNode) {
                        document.body.removeChild(notification);
                    }
                }, 300);
            }, 3000);
        }
        
        // 执行搜索
        function performSearch() {
            // 获取所有搜索框的值
            const contactSearch = searchContact.value.trim().toLowerCase();
            const phoneSearch = searchPhone.value.trim().toLowerCase();
            const plateSearch = searchPlate.value.trim().toLowerCase();
            const lineSearch = searchLine.value.trim().toLowerCase();
            const pickupSearch = searchPickup.value.trim().toLowerCase();
            const dropoffSearch = searchDropoff.value.trim().toLowerCase();
            
            // 检查是否有任何搜索条件
            const hasSearchConditions = contactSearch || phoneSearch || plateSearch || lineSearch || pickupSearch || dropoffSearch;
            
            if (!hasSearchConditions) {
                isSearchActive = false;
                filteredData = [];
                searchResultsInfo.textContent = `显示全部 ${processedData.length} 条数据`;
                searchResultsInfo.style.color = '#4a6491';
            } else {
                isSearchActive = true;
                
                filteredData = processedData.filter(item => {
                    // 检查每个搜索条件，如果条件为空，则视为匹配
                    const contactMatch = !contactSearch || (item.联系人 && item.联系人.toLowerCase().includes(contactSearch));
                    const phoneMatch = !phoneSearch || (item.联系电话 && item.联系电话.toLowerCase().includes(phoneSearch));
                    const plateMatch = !plateSearch || (item.车牌号码 && item.车牌号码.toLowerCase().includes(plateSearch));
                    const lineMatch = !lineSearch || (item.线路 && item.线路.toLowerCase().includes(lineSearch));
                    const pickupMatch = !pickupSearch || (item.上车地点 && item.上车地点.toLowerCase().includes(pickupSearch));
                    const dropoffMatch = !dropoffSearch || (item.下车地点 && item.下车地点.toLowerCase().includes(dropoffSearch));
                    
                    // 所有条件都必须匹配
                    return contactMatch && phoneMatch && plateMatch && lineMatch && pickupMatch && dropoffMatch;
                });
                
                // 构建搜索条件文本
                const searchConditions = [];
                if (contactSearch) searchConditions.push(`联系人: ${contactSearch}`);
                if (phoneSearch) searchConditions.push(`电话: ${phoneSearch}`);
                if (plateSearch) searchConditions.push(`车牌: ${plateSearch}`);
                if (lineSearch) searchConditions.push(`线路: ${lineSearch}`);
                if (pickupSearch) searchConditions.push(`上车: ${pickupSearch}`);
                if (dropoffSearch) searchConditions.push(`下车: ${dropoffSearch}`);
                
                const conditionsText = searchConditions.join('; ');
                searchResultsInfo.textContent = `找到 ${filteredData.length} 条数据 (${conditionsText})`;
                searchResultsInfo.style.color = '#2ecc71';
            }
            
            if (isDataVisible) {
                displayProcessedData();
                displayVehiclePickupStatsPanel();
            }
        }
        
        // 清除搜索
        function clearSearch() {
            isSearchActive = false;
            filteredData = [];
            searchResultsInfo.textContent = `显示全部 ${processedData.length} 条数据`;
            searchResultsInfo.style.color = '#4a6491';
            
            // 清空所有搜索输入框
            searchContact.value = '';
            searchPhone.value = '';
            searchPlate.value = '';
            searchLine.value = '';
            searchPickup.value = '';
            searchDropoff.value = '';
            
            if (isDataVisible) {
                displayProcessedData();
                displayVehiclePickupStatsPanel();
            }
        }
        
        // 过滤弹窗中的行
        function filterModalRows() {
            const lineSearch = modalSearchLine.value.trim().toLowerCase();
            const plateSearch = modalSearchPlate.value.trim().toLowerCase();
            
            const rows = document.querySelectorAll('#lineInputsBody tr');
            
            // 检查是否有任何搜索条件
            const hasSearchConditions = lineSearch || plateSearch;
            
            if (!hasSearchConditions) {
                rows.forEach(row => {
                    row.classList.remove('filtered-out');
                });
                
                // 移除之前的无结果提示
                const existingNoResults = lineInputsBody.parentNode.querySelector('.no-results');
                if (existingNoResults) {
                    existingNoResults.remove();
                }
                return;
            }
            
            let hasResults = false;
            
            rows.forEach(row => {
                // 获取行数据
                const lineCell = row.querySelector('td:nth-child(2)');
                const plateInput = row.querySelector('td:nth-child(7) input');
                
                const lineText = lineCell ? lineCell.textContent.toLowerCase() : '';
                const plateText = plateInput ? plateInput.value.toLowerCase() : '';
                
                // 检查是否匹配
                const lineMatch = !lineSearch || lineText.includes(lineSearch);
                const plateMatch = !plateSearch || plateText.includes(plateSearch);
                
                const shouldShow = lineMatch && plateMatch;
                
                if (shouldShow) {
                    row.classList.remove('filtered-out');
                    hasResults = true;
                } else {
                    row.classList.add('filtered-out');
                }
            });
            
            // 如果没有结果，显示提示
            const existingNoResults = lineInputsBody.parentNode.querySelector('.no-results');
            if (!hasResults) {
                if (!existingNoResults) {
                    const noResults = document.createElement('div');
                    noResults.className = 'no-results';
                    noResults.textContent = `未找到匹配的数据`;
                    lineInputsBody.parentNode.appendChild(noResults);
                }
            } else if (existingNoResults) {
                existingNoResults.remove();
            }
        }
        
        // 更新修改按钮状态
        function updateModifyButtonState() {
            modifyBtn.disabled = selectedRows.size === 0;
            
            if (isDataVisible) {
                updateSelectAllButtons();
            }
        }
        
        // 全选/取消全选
        function toggleSelectAll() {
            const checkboxes = document.querySelectorAll('.row-checkbox');
            const dataToSelect = isSearchActive ? filteredData : processedData;
            
            if (selectAllCheckbox.checked) {
                dataToSelect.forEach(item => {
                    selectedRows.add(item.订单ID);
                });
                
                checkboxes.forEach(checkbox => {
                    checkbox.checked = true;
                    const row = checkbox.closest('tr');
                    if (row) row.classList.add('selected-row');
                });
                
                document.querySelectorAll('.plate-checkbox').forEach(checkbox => {
                    checkbox.checked = true;
                });
                
                document.querySelectorAll('.unassigned-line-checkbox').forEach(checkbox => {
                    checkbox.checked = true;
                });
            } else {
                dataToSelect.forEach(item => {
                    selectedRows.delete(item.订单ID);
                });
                
                checkboxes.forEach(checkbox => {
                    checkbox.checked = false;
                    const row = checkbox.closest('tr');
                    if (row) row.classList.remove('selected-row');
                });
                
                document.querySelectorAll('.plate-checkbox').forEach(checkbox => {
                    checkbox.checked = false;
                });
                
                document.querySelectorAll('.unassigned-line-checkbox').forEach(checkbox => {
                    checkbox.checked = false;
                });
            }
            
            updateModifyButtonState();
        }
        
        // 显示修改弹窗
        function showModifyModal() {
            if (selectedRows.size === 0) {
                showNotification('请先选择要修改的订单', 'error');
                return;
            }
            
            const firstOrderId = Array.from(selectedRows)[0];
            const orderData = processedData.find(item => item.订单ID === firstOrderId);
            
            if (!orderData) {
                showNotification('未找到选中的订单数据', 'error');
                return;
            }
            
            const selectedLines = new Set();
            let totalTickets = 0;
            selectedRows.forEach(orderId => {
                const order = processedData.find(item => item.订单ID === orderId);
                if (order) {
                    selectedLines.add(order.线路);
                    totalTickets += (order.票数 || 0);
                }
            });
            
            let formHTML = `
                <div class="form-group">
                    <label>选中订单数量</label>
                    <div class="readonly-field">${selectedRows.size} 个订单</div>
                </div>
                <div class="form-group">
                    <label>涉及线路</label>
                    <div class="readonly-field">${Array.from(selectedLines).join('、')}</div>
                </div>
                <div class="form-group">
                    <label>总票数</label>
                    <div class="readonly-field">${totalTickets} 票</div>
                </div>
            `;

            if (selectedRows.size === 1) {
                formHTML += `
                    <div class="form-group">
                        <label>订单ID</label>
                        <div class="readonly-field">${orderData.订单ID}</div>
                    </div>
                    <div class="form-group">
                        <label>联系人</label>
                        <div class="readonly-field">${orderData.联系人}</div>
                    </div>
                    <div class="form-group">
                        <label>联系电话</label>
                        <div class="readonly-field">${orderData.联系电话}</div>
                    </div>
                    <div class="form-group">
                        <label>乘车时间</label>
                        <input type="text" id="modifyTime" class="input-field" value="${orderData.乘车时间 || ''}" placeholder="请输入乘车时间（如：08:30）">
                    </div>
                    <div class="form-group">
                        <label>上车地点</label>
                        <input type="text" id="modifyPickup" class="input-field" value="${orderData.上车地点 || ''}" placeholder="请输入上车地点">
                    </div>
                    <div class="form-group">
                        <label>下车地点</label>
                        <input type="text" id="modifyDropoff" class="input-field" value="${orderData.下车地点 || ''}" placeholder="请输入下车地点">
                    </div>
                `;
            } else {
                formHTML += `
                    <div class="form-group">
                        <label>乘车时间</label>
                        <input type="text" id="modifyTime" class="input-field" placeholder="请输入乘车时间">
                        <small style="color:#666;">为空则不修改此字段</small>
                    </div>
                    <div class="form-group">
                        <label>上车地点</label>
                        <input type="text" id="modifyPickup" class="input-field" placeholder="请输入上车地点">
                        <small style="color:#666;">为空则不修改此字段</small>
                    </div>
                    <div class="form-group">
                        <label>下车地点</label>
                        <input type="text" id="modifyDropoff" class="input-field" placeholder="请输入下车地点">
                        <small style="color:#666;">为空则不修改此字段</small>
                    </div>
                `;
            }

            formHTML += `
                <div class="form-group">
                    <label>车牌号码</label>
                    <input type="text" id="modifyPlate" class="input-field" value="${orderData.车牌号码 || ''}" placeholder="请输入车牌号码">
                    <small style="color:#666;">如果输入已有车牌号，订单将归并到该车，并更新座位统计</small>
                </div>
                <div class="form-group">
                    <label>随车负责人</label>
                    <input type="text" id="modifyManager" class="input-field" value="${orderData.随车负责人 || ''}" placeholder="请输入随车负责人">
                    <small style="color:#666;">为空则自动匹配输入车牌号中的信息</small>
                </div>
                <div class="form-group">
                    <label>随车负责人电话</label>
                    <input type="text" id="modifyManagerPhone" class="input-field" value="${orderData.随车负责人电话 || ''}" placeholder="请输入随车负责人电话">
                    <small style="color:#666;">为空则自动匹配输入车牌号中的信息</small>
                </div>
                <div class="form-group">
                    <label>通知内容</label>
                    <textarea id="modifyNotice" class="input-field" rows="3" placeholder="请输入通知内容">${orderData.通知内容 || ''}</textarea>
                    <small style="color:#666;">为空则自动匹配输入车牌号中的信息</small>
                </div>
            `;

            modifyForm.innerHTML = formHTML;
            
            // 显示或隐藏删除乘客按钮
            if (selectedRows.size === 1) {
                deletePassengerBtn.style.display = 'flex';
            } else {
                deletePassengerBtn.style.display = 'none';
            }

            modifyModalOverlay.style.display = 'flex';
        }
        
        // 关闭修改弹窗
        function closeModifyModal() {
            modifyModalOverlay.style.display = 'none';
        }
        
        // 新增：显示添加乘客弹窗
        function showAddPassengerModal() {
            // 清空所有输入框
            document.getElementById('addPassengerOrderId').value = '';
            document.getElementById('addPassengerLine').value = '';
            document.getElementById('addPassengerContact').value = '';
            document.getElementById('addPassengerPhone').value = '';
            document.getElementById('addPassengerTicketCount').value = '1';
            document.getElementById('addPassengerPickup').value = '';
            document.getElementById('addPassengerDropoff').value = '';
            document.getElementById('addPassengerDate').value = '';
            document.getElementById('addPassengerTime').value = '';
            document.getElementById('addPassengerPlate').value = '';
            document.getElementById('addPassengerManager').value = '';
            document.getElementById('addPassengerManagerPhone').value = '';
            document.getElementById('addPassengerNotice').value = '';
            document.getElementById('addPassengerNotes').value = '';
            
            addPassengerModalOverlay.style.display = 'flex';
        }
        
        // 新增：关闭添加乘客弹窗
        function closeAddPassengerModal() {
            addPassengerModalOverlay.style.display = 'none';
        }
        
        // 新增：确认添加乘客
        function confirmAddPassenger() {
            const orderId = document.getElementById('addPassengerOrderId').value.trim();
            const line = document.getElementById('addPassengerLine').value.trim();
            const contact = document.getElementById('addPassengerContact').value.trim();
            const phone = document.getElementById('addPassengerPhone').value.trim();
            const ticketCount = parseInt(document.getElementById('addPassengerTicketCount').value) || 1;
            const pickup = document.getElementById('addPassengerPickup').value.trim();
            const dropoff = document.getElementById('addPassengerDropoff').value.trim();
            const date = document.getElementById('addPassengerDate').value.trim();
            const time = document.getElementById('addPassengerTime').value.trim();
            const plate = document.getElementById('addPassengerPlate').value.trim();
            const manager = document.getElementById('addPassengerManager').value.trim();
            const managerPhone = document.getElementById('addPassengerManagerPhone').value.trim();
            const notice = document.getElementById('addPassengerNotice').value.trim();
            const notes = document.getElementById('addPassengerNotes').value.trim();
            
            // 验证必填字段
            if (!orderId || !line || !contact || !phone || !pickup || !dropoff || !date) {
                showNotification('请填写所有必填字段（订单ID、线路、联系人、联系电话、上车地点、下车地点、乘车日期）', 'error');
                return;
            }
            
            // 检查订单ID是否已存在
            const orderExists = processedData.some(item => item.订单ID === orderId);
            if (orderExists) {
                showNotification(`订单ID "${orderId}" 已存在，请使用不同的订单ID`, 'error');
                return;
            }

            // 创建新的订单对象
            const newOrder = {
                订单ID: orderId,
                线路: line,
                车牌号码: plate,
                联系人: contact,
                联系电话: phone,
                票数: ticketCount,
                通知内容: notice,
                乘车日期: date,
                乘车时间: time,
                上车地点: pickup,
                下车地点: dropoff,
                随车负责人: manager,
                随车负责人电话: managerPhone,
                查看注意事项: notes || '切勿迟到，迟到车子就走了'
            };
            
            // 新增逻辑：如果分配了已有车牌，自动填充未填写的字段
    if (plate && plate.trim()) {
        // 查找该车牌是否已有信息
        let vehicleInfo = null;
        
        // 从vehicleCapacityMap中获取车辆信息
        if (vehicleCapacityMap.has(plate)) {
            vehicleInfo = vehicleCapacityMap.get(plate);
        } else {
            // 如果vehicleCapacityMap中没有，从已有订单中查找该车牌的信息
            const existingOrderWithPlate = processedData.find(item => 
                item.车牌号码 && item.车牌号码.trim() === plate
            );
            
            if (existingOrderWithPlate) {
                vehicleInfo = {
                    随车负责人: existingOrderWithPlate.随车负责人 || "",
                    随车负责人电话: existingOrderWithPlate.随车负责人电话 || "",
                    通知内容: existingOrderWithPlate.通知内容 || ""
                };
            }
        }
        
        // 如果有车辆信息，填充未填写的字段
        if (vehicleInfo) {
            // 随车负责人：如果用户未填写，使用车辆信息
            if (!manager && vehicleInfo.随车负责人) {
                newOrder.随车负责人 = vehicleInfo.随车负责人;
            }
            
            // 随车负责人电话：如果用户未填写，使用车辆信息
            if (!managerPhone && vehicleInfo.随车负责人电话) {
                newOrder.随车负责人电话 = vehicleInfo.随车负责人电话;
            }
            
            // 通知内容：如果用户未填写，使用车辆信息
            if (!notice && vehicleInfo.通知内容) {
                newOrder.通知内容 = vehicleInfo.通知内容;
            }
        }
    }


            // 添加到processedData
            processedData.push(newOrder);
            
            // 如果指定了车牌，更新车辆统计
            if (plate && plate.trim()) {
                // 更新车辆总分配人数
                if (vehicleCapacityMap.has(plate)) {
                    const vehicleInfo = vehicleCapacityMap.get(plate);
                    const currentAssigned = vehicleTotalAssigned.get(plate) || 0;
                    vehicleTotalAssigned.set(plate, currentAssigned + ticketCount);
                    vehicleInfo.已分配人数 = currentAssigned + ticketCount;
                } else {
                    // 如果车辆不存在，创建新的车辆信息
                    vehicleCapacityMap.set(plate, {
                        乘车时间: time,
                        容量: null,
                        随车负责人: manager,
                        随车负责人电话: managerPhone,
                        通知内容: notice,
                        已分配人数: ticketCount
                    });
                    vehicleTotalAssigned.set(plate, ticketCount);
                }
                
                // 更新车牌线路映射
                if (!plateLineMap.has(plate)) {
                    plateLineMap.set(plate, new Set());
                }
                plateLineMap.get(plate).add(line);
            } else {
                // 未分配车辆，更新线路未分配人数
                if (!lineUnassignedCount[line]) {
                    lineUnassignedCount[line] = 0;
                }
                lineUnassignedCount[line] += ticketCount;
            }
            
            // 重新排序processedData
            processedData.sort((a, b) => {
                const plateA = a.车牌号码 || "";
                const plateB = b.车牌号码 || "";
                const lineA = a.线路;
                const lineB = b.线路;
                
                if (plateA && plateB) {
                    if (plateA !== plateB) {
                        return plateA.localeCompare(plateB);
                    } else {
                        return lineA.localeCompare(lineB);
                    }
                } else if (plateA && !plateB) {
                    return -1;
                } else if (!plateA && plateB) {
                    return 1;
                } else {
                    return lineA.localeCompare(lineB);
                }
            });
            
            closeAddPassengerModal();
            
            // 更新显示
            if (isDataVisible) {
                displayProcessedData();
                displayVehiclePickupStatsPanel();
                displayLineTicketStats();
                displayLineTimeLocationStats();
            }
            
            showNotification(`成功添加乘客: ${contact} (${orderId})`, 'success');
        }
        
        // 新增：显示删除确认对话框
        function showDeleteConfirmDialog() {
            if (selectedRows.size !== 1) {
                showNotification('请只选择一个订单进行删除', 'error');
                return;
            }
            
            const orderId = Array.from(selectedRows)[0];
            const orderData = processedData.find(item => item.订单ID === orderId);
            
            if (!orderData) {
                showNotification('未找到选中的订单数据', 'error');
                return;
            }
            
            deleteConfirmDialogBody.textContent = `确定要删除乘客 "${orderData.联系人}" (订单ID: ${orderId}) 吗？此操作无法撤销。`;
            deleteConfirmDialogOverlay.style.display = 'flex';
        }
        
        // 新增：关闭删除确认对话框
        function closeDeleteConfirmDialog() {
            deleteConfirmDialogOverlay.style.display = 'none';
        }
        
        // 新增：确认删除乘客
        function confirmDeletePassenger() {
            if (selectedRows.size !== 1) {
                showNotification('请只选择一个订单进行删除', 'error');
                return;
            }
            
            const orderId = Array.from(selectedRows)[0];
            const orderIndex = processedData.findIndex(item => item.订单ID === orderId);
            
            if (orderIndex === -1) {
                showNotification('未找到选中的订单数据', 'error');
                closeDeleteConfirmDialog();
                return;
            }
            
            const orderData = processedData[orderIndex];
            const plate = orderData.车牌号码 || '';
            const line = orderData.线路;
            const ticketCount = orderData.票数 || 0;
            
            // 删除订单
            processedData.splice(orderIndex, 1);
            
            // 如果订单有分配车牌，更新车辆统计
            if (plate && plate.trim()) {
                if (vehicleCapacityMap.has(plate)) {
                    const vehicleInfo = vehicleCapacityMap.get(plate);
                    const currentAssigned = vehicleTotalAssigned.get(plate) || 0;
                    const newAssigned = Math.max(0, currentAssigned - ticketCount);
                    vehicleTotalAssigned.set(plate, newAssigned);
                    vehicleInfo.已分配人数 = newAssigned;
                    
                    // 如果车辆已分配人数为0，可以考虑移除车辆信息，但这里保留
                }
                
                // 更新车牌线路映射
                if (plateLineMap.has(plate)) {
                    // 检查是否还有该线路的其他订单
                    const hasOtherOrders = processedData.some(item => 
                        item.车牌号码 === plate && item.线路 === line
                    );
                    
                    if (!hasOtherOrders) {
                        plateLineMap.get(plate).delete(line);
                        if (plateLineMap.get(plate).size === 0) {
                            plateLineMap.delete(plate);
                        }
                    }
                }
            } else {
                // 未分配车辆，更新线路未分配人数
                if (lineUnassignedCount[line]) {
                    lineUnassignedCount[line] = Math.max(0, lineUnassignedCount[line] - ticketCount);
                }
            }
            
            // 从选中行中移除
            selectedRows.delete(orderId);
            
            closeDeleteConfirmDialog();
            closeModifyModal();
            
            // 更新显示
            if (isDataVisible) {
                displayProcessedData();
                displayVehiclePickupStatsPanel();
                displayLineTicketStats();
                displayLineTimeLocationStats();
            }
            
            showNotification(`成功删除乘客: ${orderData.联系人} (${orderId})`, 'success');
            updateModifyButtonState();
        }
        
        // 确认修改
        function confirmModify() {
            const modifyTime = document.getElementById('modifyTime') ? document.getElementById('modifyTime').value : null;
            const modifyPickup = document.getElementById('modifyPickup') ? document.getElementById('modifyPickup').value : null;
            const modifyDropoff = document.getElementById('modifyDropoff') ? document.getElementById('modifyDropoff').value : null;
            const modifyPlate = document.getElementById('modifyPlate').value.trim();
            const modifyManager = document.getElementById('modifyManager').value.trim();
            const modifyManagerPhone = document.getElementById('modifyManagerPhone').value.trim();
            const modifyNotice = document.getElementById('modifyNotice').value.trim();
            
            const existingPlates = new Set();
            processedData.forEach(item => {
                if (item.车牌号码 && item.车牌号码.trim()) {
                    existingPlates.add(item.车牌号码.trim());
                }
            });
            
            let ordersToModify = Array.from(selectedRows);
            
            let updatedCount = 0;
            
            const newlyAssignedOrders = [];
            
            ordersToModify.forEach(orderId => {
                const orderIndex = processedData.findIndex(item => item.订单ID === orderId);
                if (orderIndex !== -1) {
                    const originalOrder = processedData[orderIndex];
                    
                    const oldPlate = originalOrder.车牌号码 || '';
                    const newPlate = modifyPlate;
                    const plateChanged = newPlate && newPlate !== oldPlate;
                    
                    const ticketCount = originalOrder.票数 || 0;
                    
                    const wasUnassigned = !oldPlate || oldPlate.trim() === '';
                    const nowAssigned = newPlate && newPlate.trim() !== '';
                    const becameAssigned = wasUnassigned && nowAssigned && plateChanged;
                    
                    if (newPlate && existingPlates.has(newPlate) && plateChanged) {
                        let foundVehicleInfo = null;
                        
                        if (vehicleCapacityMap.has(newPlate)) {
                            foundVehicleInfo = vehicleCapacityMap.get(newPlate);
                        } else {
                            const existingOrder = processedData.find(item => 
                                item.车牌号码 && item.车牌号码.trim() === newPlate
                            );
                            if (existingOrder) {
                                foundVehicleInfo = {
                                    乘车时间: existingOrder.乘车时间 || "",
                                    随车负责人: existingOrder.随车负责人 || "",
                                    随车负责人电话: existingOrder.随车负责人电话 || "",
                                    通知内容: existingOrder.通知内容 || ""
                                };
                            }
                        }
                        
                        if (selectedRows.size === 1) {
                            if (modifyTime !== null) processedData[orderIndex].乘车时间 = modifyTime || originalOrder.乘车时间;
                            if (modifyPickup !== null) processedData[orderIndex].上车地点 = modifyPickup || originalOrder.上车地点;
                            if (modifyDropoff !== null) processedData[orderIndex].下车地点 = modifyDropoff || originalOrder.下车地点;
                        } else {
                            if (modifyTime !== null && modifyTime.trim() !== '') processedData[orderIndex].乘车时间 = modifyTime;
                            if (modifyPickup !== null && modifyPickup.trim() !== '') processedData[orderIndex].上车地点 = modifyPickup;
                            if (modifyDropoff !== null && modifyDropoff.trim() !== '') processedData[orderIndex].下车地点 = modifyDropoff;
                        }
                        
                        processedData[orderIndex].车牌号码 = newPlate;
                        processedData[orderIndex].随车负责人 = modifyManager || foundVehicleInfo.随车负责人 || originalOrder.随车负责人;
                        processedData[orderIndex].随车负责人电话 = modifyManagerPhone || foundVehicleInfo.随车负责人电话 || originalOrder.随车负责人电话;
                        processedData[orderIndex].通知内容 = modifyNotice || foundVehicleInfo.通知内容 || originalOrder.通知内容;
                        
                        // 更新车辆总分配人数
                        if (foundVehicleInfo && vehicleCapacityMap.has(newPlate)) {
                            const vehicleInfo = vehicleCapacityMap.get(newPlate);
                            const currentAssigned = vehicleTotalAssigned.get(newPlate) || 0;
                            vehicleTotalAssigned.set(newPlate, currentAssigned + ticketCount);
                            vehicleInfo.已分配人数 = currentAssigned + ticketCount;
                        }
                        
                        if (newPlate) {
                            if (!plateLineMap.has(newPlate)) {
                                plateLineMap.set(newPlate, new Set());
                            }
                            plateLineMap.get(newPlate).add(originalOrder.线路);
                        }
                        
                        if (becameAssigned && originalOrder.线路 && lineUnassignedCount[originalOrder.线路]) {
                            lineUnassignedCount[originalOrder.线路] -= ticketCount;
                            if (lineUnassignedCount[originalOrder.线路] < 0) lineUnassignedCount[originalOrder.线路] = 0;
                            
                            manuallyAssignedOrders.add(orderId);
                            if (!lineManuallyAssignedCount[originalOrder.线路]) {
                                lineManuallyAssignedCount[originalOrder.线路] = 0;
                            }
                            lineManuallyAssignedCount[originalOrder.线路] += ticketCount;
                            newlyAssignedOrders.push({orderId, plate: newPlate, tickets: ticketCount, line: originalOrder.线路});
                        }
                        
                        if (oldPlate && vehicleCapacityMap.has(oldPlate)) {
                            const oldVehicleInfo = vehicleCapacityMap.get(oldPlate);
                            const currentAssigned = vehicleTotalAssigned.get(oldPlate) || 0;
                            vehicleTotalAssigned.set(oldPlate, Math.max(0, currentAssigned - ticketCount));
                            oldVehicleInfo.已分配人数 = Math.max(0, currentAssigned - ticketCount);
                        }
                        
                        if (oldPlate && plateLineMap.has(oldPlate)) {
                            plateLineMap.get(oldPlate).delete(originalOrder.线路);
                            if (plateLineMap.get(oldPlate).size === 0) {
                                plateLineMap.delete(oldPlate);
                            }
                        }
                        
                        showNotification(`订单 ${originalOrder.订单ID} 已归并到车牌号 ${newPlate} 下`, 'info');
                    } else {
                        if (selectedRows.size === 1) {
                            if (modifyTime !== null) processedData[orderIndex].乘车时间 = modifyTime || originalOrder.乘车时间;
                            if (modifyPickup !== null) processedData[orderIndex].上车地点 = modifyPickup || originalOrder.上车地点;
                            if (modifyDropoff !== null) processedData[orderIndex].下车地点 = modifyDropoff || originalOrder.下车地点;
                        } else {
                            if (modifyTime !== null && modifyTime.trim() !== '') processedData[orderIndex].乘车时间 = modifyTime;
                            if (modifyPickup !== null && modifyPickup.trim() !== '') processedData[orderIndex].上车地点 = modifyPickup;
                            if (modifyDropoff !== null && modifyDropoff.trim() !== '') processedData[orderIndex].下车地点 = modifyDropoff;
                        }
                        
                        if (newPlate && plateChanged) {
                            processedData[orderIndex].车牌号码 = newPlate;
                            
                            if (vehicleCapacityMap.has(newPlate)) {
                                const vehicleInfo = vehicleCapacityMap.get(newPlate);
                                const currentAssigned = vehicleTotalAssigned.get(newPlate) || 0;
                                vehicleTotalAssigned.set(newPlate, currentAssigned + ticketCount);
                                vehicleInfo.已分配人数 = currentAssigned + ticketCount;
                            } else {
                                vehicleCapacityMap.set(newPlate, {
                                    乘车时间: modifyTime || "",
                                    容量: null,
                                    随车负责人: modifyManager || "",
                                    随车负责人电话: modifyManagerPhone || "",
                                    通知内容: modifyNotice || "",
                                    已分配人数: ticketCount
                                });
                                vehicleTotalAssigned.set(newPlate, ticketCount);
                            }
                            
                            if (newPlate) {
                                if (!plateLineMap.has(newPlate)) {
                                    plateLineMap.set(newPlate, new Set());
                                }
                                plateLineMap.get(newPlate).add(originalOrder.线路);
                            }
                            
                            existingPlates.add(newPlate);
                            
                            if (becameAssigned && originalOrder.线路 && lineUnassignedCount[originalOrder.线路]) {
                                lineUnassignedCount[originalOrder.线路] -= ticketCount;
                                if (lineUnassignedCount[originalOrder.线路] < 0) lineUnassignedCount[originalOrder.线路] = 0;
                                
                                manuallyAssignedOrders.add(orderId);
                                if (!lineManuallyAssignedCount[originalOrder.线路]) {
                                    lineManuallyAssignedCount[originalOrder.线路] = 0;
                                }
                                lineManuallyAssignedCount[originalOrder.线路] += ticketCount;
                                newlyAssignedOrders.push({orderId, plate: newPlate, tickets: ticketCount, line: originalOrder.线路});
                            }
                            
                            if (oldPlate && vehicleCapacityMap.has(oldPlate)) {
                                const oldVehicleInfo = vehicleCapacityMap.get(oldPlate);
                                const currentAssigned = vehicleTotalAssigned.get(oldPlate) || 0;
                                vehicleTotalAssigned.set(oldPlate, Math.max(0, currentAssigned - ticketCount));
                                oldVehicleInfo.已分配人数 = Math.max(0, currentAssigned - ticketCount);
                            }
                            
                            if (oldPlate && plateLineMap.has(oldPlate)) {
                                plateLineMap.get(oldPlate).delete(originalOrder.线路);
                                if (plateLineMap.get(oldPlate).size === 0) {
                                    plateLineMap.delete(oldPlate);
                                }
                            }
                        } else {
                            processedData[orderIndex].车牌号码 = newPlate || originalOrder.车牌号码;
                        }
                        
                        processedData[orderIndex].随车负责人 = modifyManager || originalOrder.随车负责人;
                        processedData[orderIndex].随车负责人电话 = modifyManagerPhone || originalOrder.随车负责人电话;
                        processedData[orderIndex].通知内容 = modifyNotice || originalOrder.通知内容;
                    }
                    
                    updatedCount++;
                }
            });
            
            if (isSearchActive) {
                ordersToModify.forEach(orderId => {
                    const orderIndex = filteredData.findIndex(item => item.订单ID === orderId);
                    if (orderIndex !== -1) {
                        if (selectedRows.size === 1) {
                            if (modifyTime !== null) filteredData[orderIndex].乘车时间 = modifyTime || filteredData[orderIndex].乘车时间;
                            if (modifyPickup !== null) filteredData[orderIndex].上车地点 = modifyPickup || filteredData[orderIndex].上车地点;
                            if (modifyDropoff !== null) filteredData[orderIndex].下车地点 = modifyDropoff || filteredData[orderIndex].下车地点;
                        } else {
                            if (modifyTime !== null && modifyTime.trim() !== '') filteredData[orderIndex].乘车时间 = modifyTime;
                            if (modifyPickup !== null && modifyPickup.trim() !== '') filteredData[orderIndex].上车地点 = modifyPickup;
                            if (modifyDropoff !== null && modifyDropoff.trim() !== '') filteredData[orderIndex].下车地点 = modifyDropoff;
                        }
                        
                        filteredData[orderIndex].车牌号码 = modifyPlate || filteredData[orderIndex].车牌号码;
                        filteredData[orderIndex].随车负责人 = modifyManager || filteredData[orderIndex].随车负责人;
                        filteredData[orderIndex].随车负责人电话 = modifyManagerPhone || filteredData[orderIndex].随车负责人电话;
                        filteredData[orderIndex].通知内容 = modifyNotice || filteredData[orderIndex].通知内容;
                    }
                });
            }
            
            closeModifyModal();
            
            if (newlyAssignedOrders.length > 0) {
                let totalTickets = 0;
                const plates = new Set();
                newlyAssignedOrders.forEach(item => {
                    totalTickets += item.tickets;
                    plates.add(item.plate);
                });
                
                const platesText = Array.from(plates).join('、');
                showNotification(`已将 ${totalTickets} 人手动分配到车辆 ${platesText}，请查看车辆统计面板`, 'info');
            }
            
            if (isDataVisible) {
                displayProcessedData();
                displayVehiclePickupStatsPanel();
                displayLineTicketStats();
                displayLineTimeLocationStats();
                
                ordersToModify.forEach(orderId => {
                    const row = document.querySelector(`tr[data-order-id="${orderId}"]`);
                    if (row) {
                        row.classList.add('highlight-row');
                        setTimeout(() => {
                            row.classList.remove('highlight-row');
                        }, 1500);
                    }
                });
            }
            
            showNotification(`成功修改 ${updatedCount} 个订单的信息`, 'success');
            
            selectedRows.clear();
            updateModifyButtonState();
        }
        
        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
            showNotification('系统已就绪，请上传Excel文件或点击"刷新"按钮生成示例数据', 'info');
            
            analyzeBtn.disabled = true;
        });
    </script>
</body>
</html>